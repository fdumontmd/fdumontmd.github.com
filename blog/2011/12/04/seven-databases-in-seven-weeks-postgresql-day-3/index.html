
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Seven Databases in Seven Weeks PostgreSQL Day 3 - Wakatta!</title>
  <meta name="author" content="Frédéric Dumont">

  
  <meta name="description" content="Third and final day with PostgreSQL. Today all kind of text and other fancy searches are looked at. Here the SQL standard is resolutely left behind, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.wakatta.jp/blog/2011/12/04/seven-databases-in-seven-weeks-postgresql-day-3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Wakatta!" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26245052-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Wakatta!</a></h1>
  
    <h2>Like Eureka!, only cooler</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.wakatta.jp" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Seven Databases in Seven Weeks PostgreSQL Day 3</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-04T20:19:00+09:00" pubdate data-updated="true">Dec 4<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Third and final day with PostgreSQL. Today all kind of text and other fancy searches are looked at. Here the SQL standard is resolutely left behind, as pretty much everything is PostgreSQL specific.</p>

<p>PostgreSQL manages advanced index data structures that allow it to efficiently query data using something better than basic comparisons. It especially shines in its handling of geospatial data (searching by distance is a non-trivial problem), but has many options for text searches as well.</p>

<!--more-->


<p>Now, it can be easy to get carried away and try to use PostgreSQL for everything, even when a superior alternative option exists. If I had any need for a full text search, I would also look at <a href="http://lucene.apache.org/java/docs/index.html">Lucene</a> and related options. But PostgreSQL can still provide an easy, integrated solution for many situations.</p>

<h3>On indexes</h3>

<p>Indexes are not like pixie dust: you cannot just add some and hope all your performance problems will go away (as I learned the hard way). Benchmarks and the <a href="http://www.postgresql.org/docs/current/static/sql-explain.html"><code>EXPLAIN</code></a> command must be used to confirm the improvements brought by any index.</p>

<p>This section is based on the first beta version of the book. I hope they fill clarify this part in the final version.</p>

<p>First, let&#8217;s look a bit more at the fist index introduced today:</p>

<figure class='code'><figcaption><span>Text Pattern index  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">movies_title_pattern</span> <span class="k">ON</span> <span class="n">movies</span> <span class="p">(</span><span class="n">title</span> <span class="n">text_pattern_ops</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The book states that is creates an index for pattern matching. Think about it for a few seconds, try to imagine what it would look like&#8230; Yes, the solution is not trivial, so being able to index for pattern matching sounds like magic. Or pixie dust. But does it work?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>book=# EXPLAIN SELECT title FROM movies WHERE title ILIKE 'stardust_%';
</span><span class='line'>                       QUERY PLAN                        
</span><span class='line'>---------------------------------------------------------
</span><span class='line'> Seq Scan on movies  (cost=0.00..160.76 rows=1 width=15)
</span><span class='line'>   Filter: (title ~~* 'stardust_%'::text)
</span><span class='line'>(2 rows)</span></code></pre></td></tr></table></div></figure>


<p>It seems that no, it does not work. The optimizer proposes to use a sequential scan, not an index.</p>

<p>The problem here is that <code>ILIKE</code> is not really supported by the optimizer. It is a PostgreSQL extension which, while useful, is not that well integrated. The standard (and SQL compliant) way to do a case insensitive search is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>book=# EXPLAIN SELECT title FROM movies WHERE lower(title) LIKE 'stardust_%';
</span><span class='line'>                        QUERY PLAN                        
</span><span class='line'>----------------------------------------------------------
</span><span class='line'> Seq Scan on movies  (cost=0.00..167.91 rows=14 width=15)
</span><span class='line'>   Filter: (lower(title) ~~ 'stardust_%'::text)
</span><span class='line'>(2 rows)</span></code></pre></td></tr></table></div></figure>


<p>Ok, not quite there yet. But that&#8217;s normal. We are not using the column directly, so an index on the original values is not going to work. However PostgreSQL has a very nice feature called functional index: it is possible to create an index on the result of a function. Let&#8217;s drop the original index and create one with <code>lower(title)</code> as the indexed value:</p>

<figure class='code'><figcaption><span>Case insensitive Pattern index  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">DROP</span> <span class="k">INDEX</span> <span class="n">movies_title_pattern</span><span class="p">;</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">movies_title_pattern</span> <span class="k">ON</span> <span class="n">movies</span> <span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="n">text_pattern_ops</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Does it look better now?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>book=# EXPLAIN SELECT title FROM movies WHERE lower(title) LIKE 'stardust_%';
</span><span class='line'>                                             QUERY PLAN                                             
</span><span class='line'>----------------------------------------------------------------------------------------------------
</span><span class='line'> Bitmap Heap Scan on movies  (cost=4.40..46.55 rows=14 width=15)
</span><span class='line'>   Filter: (lower(title) ~~ 'stardust_%'::text)
</span><span class='line'>   -&gt;  Bitmap Index Scan on movies_title_pattern  (cost=0.00..4.40 rows=14 width=0)
</span><span class='line'>         Index Cond: ((lower(title) ~&gt;=~ 'stardust'::text) AND (lower(title) ~&lt;~ 'stardusu'::text))
</span><span class='line'>(4 rows)</span></code></pre></td></tr></table></div></figure>


<p>Yes, that&#8217;s better. What about <code>ILIKE</code>?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>book=# EXPLAIN SELECT title FROM movies WHERE title ILIKE 'stardust_%';
</span><span class='line'>                       QUERY PLAN                        
</span><span class='line'>---------------------------------------------------------
</span><span class='line'> Seq Scan on movies  (cost=0.00..160.76 rows=1 width=15)
</span><span class='line'>   Filter: (title ~~* 'stardust_%'::text)
</span><span class='line'>(2 rows)</span></code></pre></td></tr></table></div></figure>


<p>No, it still cannot use the index.</p>

<p>What about the regular expression query?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>book=# EXPLAIN SELECT COUNT(*) FROM movies WHERE title !~* '^the.*';
</span><span class='line'>                           QUERY PLAN                            
</span><span class='line'>-----------------------------------------------------------------
</span><span class='line'> Aggregate  (cost=166.32..166.33 rows=1 width=0)
</span><span class='line'>   -&gt;  Seq Scan on movies  (cost=0.00..160.76 rows=2225 width=0)
</span><span class='line'>         Filter: (title !~* '^the.*'::text)
</span><span class='line'>(3 rows)</span></code></pre></td></tr></table></div></figure>


<p>No, it does not like the case insensitive operator. Would a <code>lower(title)</code> conversion work?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>book=# EXPLAIN SELECT COUNT(*) FROM movies WHERE lower(title) !~ '^the.*';
</span><span class='line'>                           QUERY PLAN                            
</span><span class='line'>-----------------------------------------------------------------
</span><span class='line'> Aggregate  (cost=175.03..175.04 rows=1 width=0)
</span><span class='line'>   -&gt;  Seq Scan on movies  (cost=0.00..167.91 rows=2847 width=0)
</span><span class='line'>         Filter: (lower(title) !~ '^the.*'::text)
</span><span class='line'>(3 rows)</span></code></pre></td></tr></table></div></figure>


<p>Still not. Well, we&#8217;re not looking for a particular pattern, but for everything else. A negation is not easy to propagate through the optimizer logic, so it should not be surprising that it still cannot use the index. But this (almost) similar query does:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>book=# EXPLAIN SELECT COUNT(*) FROM movies WHERE lower(title) ~ '^the.*';
</span><span class='line'>                                           QUERY PLAN                                           
</span><span class='line'>------------------------------------------------------------------------------------------------
</span><span class='line'> Aggregate  (cost=46.59..46.60 rows=1 width=0)
</span><span class='line'>   -&gt;  Bitmap Heap Scan on movies  (cost=4.40..46.55 rows=14 width=0)
</span><span class='line'>         Filter: (lower(title) ~ '^the.*'::text)
</span><span class='line'>         -&gt;  Bitmap Index Scan on movies_title_pattern  (cost=0.00..4.40 rows=14 width=0)
</span><span class='line'>               Index Cond: ((lower(title) ~&gt;=~ 'the'::text) AND (lower(title) ~&lt;~ 'thf'::text))
</span><span class='line'>(5 rows)</span></code></pre></td></tr></table></div></figure>


<p>Interestingly, the trigram based index can help <code>ILIKE</code> queries as explained <a href="http://www.postgresonline.com/journal/archives/212-PostgreSQL-9.1-Trigrams-teaching-LIKE-and-ILIKE-new-tricks.html">here</a> (in general, the <a href="http://www.postgresonline.com/">Postgres OnLine Journal</a> is a very good resource on PostgreSQL more advanced features).</p>

<p>But the general conclusion and take-home lesson is that adding indexes without checking their impact on queries is more than useless: it adds cost on data creation and update, with not compensation at query time.</p>

<h2>Exercises</h2>

<h3>Contributed Packages</h3>

<p>The contributed packages shipped with PostgreSQL are documented <a href="http://www.postgresql.org/docs/current/static/contrib.html">here</a>.</p>

<h3>POSIX Regex</h3>

<p>The Wikipedia <a href="http://en.wikipedia.org/wiki/Regular_expression#Syntax">page</a> on the topic is already very good.</p>

<h3>Stored Procedure based movie recommendation</h3>

<p>I&#8217;m assuming the name of an actor or movie can have errors (after all, end users are known to make and cause errors). The first step will be to identify whether the name is closer to an actor&#8217;s name or a movie&#8217;s name. The second step will use existing queries to either propose 5 movies from the same actor if the name was closer to an actor&#8217;s name or 5 similar movies (using the cube bounding technique) if the name was closer to a movie&#8217;s.</p>

<p>The use of <code>UNION</code> over several strategies to identify either movies or actors gives a lot of freedom. I use the <code>levenshtein</code> function to select the best match identified by each strategy.</p>

<p>Also, because the full text search query must have a specific format (for instance, each search term must be separated by <code>&amp;</code>), I use a few text replacement functions to clean up the input search.</p>

<p>Finally, the return value is a <code>setof</code> <code>movies</code>. The meaning is that I will return rows that have the same type as rows from the <code>movies</code> table. If the query was simple, I could just use the <code>SELECT</code> statement as the body for the function, but as I have to chose between queries, I use the <a href=""><code>RETURN NEXT</code></a> command instead. Explanations can be found in the fine PostgreSQL <a href="http://www.postgresql.org/docs/current/static/plpgsql-control-structures.html">manual</a>.</p>

<figure class='code'><figcaption><span>suggestMovies function  (suggest_movies.sql)</span> <a href='/downloads/code/7d7w/postgresql/suggest_movies.sql'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">suggest_movies</span><span class="p">(</span><span class="k">search</span> <span class="nb">text</span><span class="p">)</span>
</span><span class='line'><span class="k">RETURNS</span> <span class="k">SETOF</span> <span class="n">movies</span> <span class="k">AS</span> <span class="err">$$</span>
</span><span class='line'><span class="k">DECLARE</span>
</span><span class='line'>  <span class="n">found_name</span> <span class="nb">text</span><span class="p">;</span>
</span><span class='line'>  <span class="n">found_type</span> <span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="n">tempmovie</span> <span class="n">movies</span><span class="o">%</span><span class="n">rowtype</span><span class="p">;</span>
</span><span class='line'>  <span class="n">movie_query</span> <span class="n">tsquery</span><span class="p">;</span>
</span><span class='line'><span class="k">BEGIN</span>
</span><span class='line'>  <span class="n">movie_query</span> <span class="p">:</span><span class="o">=</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="n">regexp_replace</span><span class="p">(</span><span class="k">trim</span><span class="p">(</span><span class="k">search</span><span class="p">),</span> <span class="s1">&#39; +&#39;</span> <span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">),</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">));</span>
</span><span class='line'>  <span class="k">SELECT</span> <span class="k">INTO</span> <span class="n">found_name</span><span class="p">,</span> <span class="n">found_type</span>
</span><span class='line'>              <span class="n">name</span><span class="p">,</span> <span class="k">type</span>
</span><span class='line'>  <span class="k">FROM</span> <span class="p">(</span>
</span><span class='line'>    <span class="k">SELECT</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span> <span class="k">AS</span> <span class="k">type</span><span class="p">,</span> <span class="n">levenshtein</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="k">search</span><span class="p">),</span> <span class="k">lower</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">))</span> <span class="k">AS</span> <span class="n">dist</span>
</span><span class='line'>      <span class="k">FROM</span> <span class="n">actors</span> <span class="n">a</span> <span class="k">WHERE</span> <span class="k">search</span> <span class="o">%</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span>
</span><span class='line'>    <span class="k">UNION</span>
</span><span class='line'>  <span class="k">SELECT</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span> <span class="k">AS</span> <span class="k">type</span><span class="p">,</span> <span class="n">levenshtein</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="k">search</span><span class="p">),</span> <span class="k">lower</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">))</span> <span class="k">AS</span> <span class="n">dist</span>
</span><span class='line'>        <span class="k">FROM</span> <span class="n">actors</span> <span class="n">a</span> <span class="k">WHERE</span> <span class="n">metaphone</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">metaphone</span><span class="p">(</span><span class="k">search</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</span><span class='line'>  <span class="k">UNION</span>
</span><span class='line'>  <span class="k">SELECT</span> <span class="n">m</span><span class="p">.</span><span class="n">title</span> <span class="k">AS</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span> <span class="k">AS</span> <span class="k">type</span><span class="p">,</span> <span class="n">levenshtein</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="k">search</span><span class="p">),</span> <span class="k">lower</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">title</span><span class="p">))</span> <span class="k">AS</span> <span class="n">dist</span>
</span><span class='line'>      <span class="k">FROM</span> <span class="n">movies</span> <span class="n">m</span> <span class="k">WHERE</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">title</span><span class="p">)</span> <span class="o">@@</span> <span class="n">movie_query</span>
</span><span class='line'>       <span class="p">)</span> <span class="n">t</span>
</span><span class='line'>  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">dist</span> <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">IF</span> <span class="n">found_type</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span> <span class="k">THEN</span>
</span><span class='line'>    <span class="k">FOR</span> <span class="n">tempmovie</span> <span class="k">IN</span> <span class="k">SELECT</span> <span class="n">m</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="n">movies</span> <span class="n">m</span> <span class="k">NATURAL</span> <span class="k">JOIN</span> <span class="n">movies_actors</span> <span class="k">NATURAL</span> <span class="k">JOIN</span> <span class="n">actors</span>
</span><span class='line'>                     <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="n">found_name</span> <span class="k">LIMIT</span> <span class="mi">5</span> <span class="n">LOOP</span>
</span><span class='line'>      <span class="k">RETURN</span> <span class="k">NEXT</span> <span class="n">tempmovie</span><span class="p">;</span>
</span><span class='line'>    <span class="k">END</span> <span class="n">LOOP</span><span class="p">;</span>
</span><span class='line'>  <span class="k">ELSE</span>
</span><span class='line'>    <span class="k">FOR</span> <span class="n">tempmovie</span> <span class="k">IN</span> <span class="k">SELECT</span> <span class="n">m</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="n">movies</span> <span class="n">m</span><span class="p">,</span>
</span><span class='line'>                       <span class="p">(</span><span class="k">SELECT</span> <span class="n">genre</span><span class="p">,</span> <span class="n">title</span> <span class="k">FROM</span> <span class="n">movies</span> <span class="k">WHERE</span> <span class="n">title</span> <span class="o">=</span> <span class="n">found_name</span><span class="p">)</span> <span class="n">s</span>
</span><span class='line'>                       <span class="k">WHERE</span> <span class="n">cube_enlarge</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">genre</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="o">@&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">genre</span> <span class="k">AND</span> <span class="n">s</span><span class="p">.</span><span class="n">title</span> <span class="o">&lt;&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">title</span>
</span><span class='line'>                       <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">cube_distance</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">genre</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">genre</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">5</span> <span class="n">LOOP</span>
</span><span class='line'>      <span class="k">RETURN</span> <span class="k">NEXT</span> <span class="n">tempmovie</span><span class="p">;</span>
</span><span class='line'>    <span class="k">END</span> <span class="n">LOOP</span><span class="p">;</span>
</span><span class='line'>  <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
</span><span class='line'><span class="k">END</span><span class="p">;</span>
</span><span class='line'><span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Some testing:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>book=# select * from suggest_movies('Ben Aflk');
</span><span class='line'> movie_id |       title       |                          genre                          
</span><span class='line'>----------+-------------------+---------------------------------------------------------
</span><span class='line'>       22 | Armageddon        | (5, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
</span><span class='line'>      146 | Good Will Hunting | (0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
</span><span class='line'>      476 | Forces of Nature  | (0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
</span><span class='line'>      514 | Dogma             | (0, 0, 0, 5, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0)
</span><span class='line'>      609 | Chasing Amy       | (0, 0, 0, 5, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
</span><span class='line'>(5 rows)
</span><span class='line'>
</span><span class='line'>book=# select * from suggest_movies('Broos Weells');
</span><span class='line'> movie_id |       title       |                          genre                           
</span><span class='line'>----------+-------------------+----------------------------------------------------------
</span><span class='line'>        6 | The Fifth Element | (0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0)
</span><span class='line'>        9 | Twelve Monkeys    | (0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 7, 0, 7, 0)
</span><span class='line'>       22 | Armageddon        | (5, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
</span><span class='line'>      171 | Die Hard          | (7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
</span><span class='line'>      230 | Pulp Fiction      | (0, 0, 0, 12, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0)
</span><span class='line'>(5 rows)
</span><span class='line'>
</span><span class='line'>book=# select * from suggest_movies('war star');
</span><span class='line'> movie_id |                     title                      |                          genre                          
</span><span class='line'>----------+------------------------------------------------+---------------------------------------------------------
</span><span class='line'>      532 | Star Wars: Episode V - The Empire Strikes Back | (0, 7, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 2, 10, 0, 0, 0)
</span><span class='line'>     2862 | Avatar                                         | (0, 7, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 5, 10, 0, 0, 0)
</span><span class='line'>     1357 | Explorers                                      | (0, 5, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 5, 0, 0, 0)
</span><span class='line'>      325 | Krull                                          | (0, 5, 0, 0, 0, 0, 0, 5, 0, 5, 0, 0, 0, 0, 7, 0, 0, 0)
</span><span class='line'>      193 | E.T. The Extra-Terrestrial                     | (0, 5, 0, 0, 0, 0, 0, 5, 0, 5, 0, 0, 0, 0, 5, 0, 0, 0)
</span><span class='line'>(5 rows)</span></code></pre></td></tr></table></div></figure>


<p>Groovy.</p>

<h2>Wrapping Up PostgreSQL</h2>

<p>Well, not really wrapping it up. I&#8217;ll keep using it, if only for fun. This database is powerful, mature, well documented, and extremely flexible over the domain of relational modeling. It is possible to define user defined types with arbitrary content, and fancy indexing. If you find an obscure academic paper describing a exotic indexing for a new datatype, chances are that PostgreSQL will support it, given enough C programming.</p>

<p>The comments from the book on this database are very fair, and I would strongly recommend anyone to give it a good and honest evaluation.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Frédéric Dumont</span></span>

      








  


<time datetime="2011-12-04T20:19:00+09:00" pubdate data-updated="true">Dec 4<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/books/'>Books</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.wakatta.jp/blog/2011/12/04/seven-databases-in-seven-weeks-postgresql-day-3/" data-via="" data-counturl="http://blog.wakatta.jp/blog/2011/12/04/seven-databases-in-seven-weeks-postgresql-day-3/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/12/03/seven-databases-in-seven-weeks-postgresql-day-2/" title="Previous Post: Seven Databases in Seven Weeks PostgreSQL Day 2">&laquo; Seven Databases in Seven Weeks PostgreSQL Day 2</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Wakatta!</h1>
  <p>
		<a href="/about">more...</a>
	</p>
</section>

<section>
	<h1>Seven Databases in Seven Weeks Series</h1>
	
		<ul>
		
			<li class="post"><a href="/blog/2011/12/03/new-book-seven-databases-in-seven-weeks/">Intro</a></li>
		
			<li class="post"><a href="/blog/2011/12/03/seven-databases-in-seven-weeks-postgresql-day-1/">PostgreSQL Day 1</a></li>
		
			<li class="post"><a href="/blog/2011/12/03/seven-databases-in-seven-weeks-postgresql-day-2/">PostgreSQL Day 2</a></li>
		
			<li class="post"><a href="/blog/2011/12/04/seven-databases-in-seven-weeks-postgresql-day-3/">PostgreSQL Day 3</a></li>
		
		</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/12/04/seven-databases-in-seven-weeks-postgresql-day-3/">Seven Databases in Seven Weeks PostgreSQL Day 3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/03/seven-databases-in-seven-weeks-postgresql-day-2/">Seven Databases in Seven Weeks PostgreSQL Day 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/03/seven-databases-in-seven-weeks-postgresql-day-1/">Seven Databases in Seven Weeks PostgreSQL Day 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/03/new-book-seven-databases-in-seven-weeks/">New Book: Seven Databases in Seven Weeks</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/26/seven-languages-in-seven-weeks-wrap-up/">Seven Languages in Seven Weeks Wrap Up</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/fdumontmd">@fdumontmd</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'fdumontmd',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Frédéric Dumont -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'wakatta-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.wakatta.jp/blog/2011/12/04/seven-databases-in-seven-weeks-postgresql-day-3/';
        var disqus_url = 'http://blog.wakatta.jp/blog/2011/12/04/seven-databases-in-seven-weeks-postgresql-day-3/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
