
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Seven Databases in Seven Weeks CouchDB Day 3 - Wakatta!</title>
  <meta name="author" content="Frédéric Dumont">

  
  <meta name="description" content="Today is a bit juicier than the previous days (together). On the menu,
advanced views (full MapReduce), replication, conflict management, and
change &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.wakatta.jp/blog/2012/02/01/seven-databases-in-seven-weeks-couchdb-day-3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Wakatta!" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">



  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26245052-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Wakatta!</a></h1>
  
    <h2>Like Eureka!, only cooler</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.wakatta.jp" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Seven Databases in Seven Weeks CouchDB Day 3</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-01T18:06:00+09:00" pubdate data-updated="true">Feb 1<span>st</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Today is a bit juicier than the previous days (together). On the menu,
advanced views (full MapReduce), replication, conflict management, and
change monitoring.</p>

<!-- more -->


<h3>Advanced views</h3>

<p><a href="http://wiki.apache.org/couchdb/Introduction_to_CouchDB_views">Advanced views</a>
in CouchDB are, as noted yesterday, materialized output of MapReduce
computations.</p>

<p>This has a cost: such computations are saved, so they take more time
than with other implementations, the first time at least.</p>

<p>Updating the views, on the other hand, is fairly fast (CouchDB
recomputes only what is necessary). Views have to be planned, but
once there they are fairly cheap. For exploratory queries, other databases
might be more appropriate.</p>

<p>CouchDB&#8217;s reduce functions distinguishes between the first invocation,
and the following ones (on values that have already gone through the
reduce function). This makes it possible to implement a <code>_count</code>
function which counts the number of values (the first invocation
transforms values into numbers, and the following ones add the numbers
up).</p>

<h3>Replication</h3>

<p><a href="http://wiki.apache.org/couchdb/Replication">Replication</a> is the
one-way process of replicating the changes of one database on
another. Replication can be between any two databases, whether on the
same server or on different ones. It can be one time, or
continuous. The documents to replicate can be filtered, or selected by
<code>_id</code>.</p>

<p>Replication is a lower level mechanism than what MongoDB, for
instance, proposes (where there is a strict hierarchy of masters and
slaves), and closer to the flexible approach or Riak.</p>

<p>Of course, when concurrent writes are permitted, conflicts can occur,
and CouchDB handles them.</p>

<h3>Conflicts</h3>

<p><a href="http://wiki.apache.org/couchdb/Replication_and_conflicts">Concurrent updates</a>
can cause conflicts, and CouchDB detects them so they can be dealt
with.</p>

<p>First, conflicts cannot happen on a single server: updates to a
document must refer to the latest revision, otherwise the update
fails. So clients are directly aware that they need to resubmit the
(merged) document.</p>

<p>When replication is enabled, conflicts result from concurrent updates
in two replicated databases. At the next replication, one version will
be selected as winning, and replicated to other databases. The other
versions are still accessible from the <code>_conflicts</code> attribute
(initially, only in the losing databases).</p>

<p>If two ways replications are in place, eventually, all databases will
have the <code>_conflicts</code> attribute populated (with all the losing
revisions, if there are more than one).</p>

<p>This makes it possible to implement a remedial action; it is possible
to have views with only documents in conflicts, or to filter changes
for conflicts, and implement merging actions in monitoring scripts.</p>

<p>CouchDB documentation helpfully provides some
<a href="http://wiki.apache.org/couchdb/How_to_design_for_replication">advice</a>
for designing conflict-aware applications.</p>

<h3>Changes</h3>

<p>Changes are dedicated views that contains a list of updates for a
specific database. The
<a href="http://wiki.apache.org/couchdb/HTTP_database_API#Changes">parameters</a>
support starting at a given revision (in this case, a database
revision, not a document revision), filtering documents, and keeping
the stream open in several ways.</p>

<p>This makes it possible (easy, even) to monitor (interesting or
relevant) changes, to synchronize with other systems, or to
automatically resolve conflicts, for instance.</p>

<p>When using Long-Polling, I found that one very large datasets, the
<code>JSON.parse</code> invocation could take a long time, and would suggest to
always use a <code>limit</code> parameter on the query, to cut the dataset down
to manageable chunks.</p>

<h2>Exercises</h2>

<h3>Built-in Reduce Functions</h3>

<p>There are three, documented on the
<a href="http://wiki.apache.org/couchdb/Built-In_Reduce_Functions">Wiki</a>.</p>

<p>They are implemented directly in Erlang, so they have a better
performance than JavaScript functions.</p>

<h4><code>_sum</code></h4>

<p>This function behaves just as the reduce function from the book; it
sums the values by key. It is useful when the map functions uses
<code>emit(key, 1);</code> (or some other numeric value).</p>

<h4><code>_count</code></h4>

<p>It is similar to <code>_sum</code>, but it counts the number of values rather
than merely summing them. It is useful when the value is not a number.</p>

<h4><code>_stat</code></h4>

<p>This is an extension of <code>_sum</code> which computes additional statistics
(minimum, maximum, &#8230;) on the numeric values.</p>

<h3>Filtering <code>_changes</code> output</h3>

<p>Filters are nicely described in
<a href="http://guide.couchdb.org/draft/notifications.html#filters">CouchDB The Definitive Guide</a>.</p>

<p>To create a new filter, I first create a design document to store the function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -X PUT http://localhost:5984/music/_design/filters \
</span><span class='line'>-d '{ "filters": { "by_country": "function(doc, req) {
</span><span class='line'>return doc.country == req.query.country; }" } }'</span></code></pre></td></tr></table></div></figure>


<p>The <code>by_country</code> function retrieves a <code>country</code> parameter from the
request, and compares it against the record <code>country</code> attribute; only
the matching records are returned.</p>

<p>To monitor only updates to bands from Spain, for instance, I can use</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl http://localhost:5984/music/_changes?filter=filters/by_country\&country=ESP</span></code></pre></td></tr></table></div></figure>


<p>To monitor for conflicts, I have the following design document:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;_design/filters&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;3-ec032384bf365d3caef0ed91185ae45a&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;filters&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>       <span class="s2">&quot;by_country&quot;</span><span class="o">:</span> <span class="s2">&quot;function(doc, req) { return doc.country == req.query.country; }&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="s2">&quot;conflicts&quot;</span><span class="o">:</span> <span class="s2">&quot;function(doc, req) { return doc._conflicts; }&quot;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With that, I can then listen for changes, keeping only the conflicts:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://localhost:5984/music-repl/_changes?filter=filters/conflicts\&since=26000
</span><span class='line'>{"results":[
</span><span class='line'>{"seq":26994,"id":"theconflicts","changes":[{"rev":"2-cab47bf4444a20d6a2d2204330fdce2a"}]}
</span><span class='line'>],
</span><span class='line'>"last_seq":27000}</span></code></pre></td></tr></table></div></figure>


<p>Because CouchDB only set the <code>_conflicts</code> attribute on the
losing database; the winner database (the one in which the winning
revision was initially created) does not know about conflicts. This
means I must check against <code>music-repl</code> instead of <code>music</code>.</p>

<h3>Replication HTTP API</h3>

<p>The API is documented
<a href="http://www.couchbase.org/sites/default/files/uploads/all/documentation/couchbase-api-misc.html#couchbase-api-misc_replicate_post">here</a>.</p>

<p>To use it, simply pass the <code>source</code> and <code>target</code> databases to the
<code>_replicate</code> URL:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -X POST http://localhost:5984/_replicate \
</span><span class='line'>-H 'Content-Type: application/json' \
</span><span class='line'>-H 'Accept: application/json' -d \
</span><span class='line'>'{ "source" : "music", "target" : "music-repl" }'</span></code></pre></td></tr></table></div></figure>


<h3><code>_replicator</code> database</h3>

<p>The
<a href="http://docs.couchbase.org/couchdb-release-1.1/couchb-release-1.1-replicatordb.html"><code>_replicator</code> database</a>
is an alternative to the use of the
<code>_replicate</code> URL above: documents inserted in the <code>_replicator</code>
database will, if properly formed, cause a replication job to be
started (either one-off, or continuous).</p>

<p>Deleting the document will cancel the replication job.</p>

<p>Document describing replications are updated to reflect the progress
of the job.</p>

<p>The command below triggers a replication from <code>music</code> to <code>music-repl</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -X PUT http://localhost:5984/_replicator/music-rep \
</span><span class='line'>-H 'Content-type: application/json' \
</span><span class='line'>-d '{ "source" : "music", "target" : "music-repl" }'
</span><span class='line'>{"ok":true,"id":"music-rep","rev":"1-ba761c16b5ca36848b2474758cbc4b22"}</span></code></pre></td></tr></table></div></figure>


<p>Using the <code>watch_changes_longpolling_impl.js</code> script on the <code>_replicator</code>
database, it is possible to monitor the replication job:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ node watch_changes_longpolling_impl.js _replicator
</span><span class='line'>... elided ...
</span><span class='line'>{ seq: 2,
</span><span class='line'>  id: 'music-rep',
</span><span class='line'>  changes: [ { rev: '1-ba761c16b5ca36848b2474758cbc4b22' } ],
</span><span class='line'>  doc: 
</span><span class='line'>   { _id: 'music-rep',
</span><span class='line'>     _rev: '1-ba761c16b5ca36848b2474758cbc4b22',
</span><span class='line'>     source: 'music',
</span><span class='line'>     target: 'music-repl' } }
</span><span class='line'>{ seq: 3,
</span><span class='line'>  id: 'music-rep',
</span><span class='line'>  changes: [ { rev: '2-d1b4fc9da1ef17d43fa91dd7b345a9e6' } ],
</span><span class='line'>  doc: 
</span><span class='line'>   { _id: 'music-rep',
</span><span class='line'>     _rev: '2-d1b4fc9da1ef17d43fa91dd7b345a9e6',
</span><span class='line'>     source: 'music',
</span><span class='line'>     target: 'music-repl',
</span><span class='line'>     _replication_state: 'triggered',
</span><span class='line'>     _replication_state_time: '2012-02-02T10:23:44+09:00',
</span><span class='line'>     _replication_id: 'ab65eb4c4ca880bf65e02626573ef683' } }
</span><span class='line'>{ seq: 4,
</span><span class='line'>  id: 'music-rep',
</span><span class='line'>  changes: [ { rev: '3-b6d32c3ce979af8dc2190735aa39d4f3' } ],
</span><span class='line'>  doc: 
</span><span class='line'>   { _id: 'music-rep',
</span><span class='line'>     _rev: '3-b6d32c3ce979af8dc2190735aa39d4f3',
</span><span class='line'>     source: 'music',
</span><span class='line'>     target: 'music-repl',
</span><span class='line'>     _replication_state: 'completed',
</span><span class='line'>     _replication_state_time: '2012-02-02T10:23:46+09:00',
</span><span class='line'>     _replication_id: 'ab65eb4c4ca880bf65e02626573ef683' } }
</span><span class='line'>... elided ...</span></code></pre></td></tr></table></div></figure>


<p>The first change is when the document is created; the second when the
job starts, and the third when it successfully completes.</p>

<p>Unlike the <code>_replicate</code> based API, continuous jobs stored in
<code>_replicator</code> will resume when the database is restarted.</p>

<h3>Continuous watcher skeleton</h3>

<p>The approach is to keep input in a buffer, then extract as many line
from the buffer as possible (if the last line is incomplete, it is put
back into the buffer), and parse each line as a JSON object.</p>

<p>The format of each parsed object is different: each change is in its
own object, so there is no <code>results</code> attribute any more.</p>

<figure class='code'><figcaption><span>watch_changes_continuous.js  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">http_options</span> <span class="o">=</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nx">host</span><span class="o">:</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">port</span><span class="o">:</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">db</span> <span class="o">+</span> <span class="s1">&#39;/_changes&#39;</span> <span class="o">+</span>
</span><span class='line'>            <span class="s1">&#39;?feed=continuous&amp;include_docs=true&amp;since=&#39;</span> <span class="o">+</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">last_seq</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">processLine</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// don&#39;t emit last_seq</span>
</span><span class='line'>            <span class="c1">// watcher.last_seq not used in this code</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">output</span><span class="p">.</span><span class="nx">last_seq</span><span class="p">)</span>
</span><span class='line'>                <span class="nx">watcher</span><span class="p">.</span><span class="nx">last_seq</span> <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">last_seq</span><span class="p">;</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>                <span class="nx">watcher</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">watcher</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">checkForData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">lines</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// if the last character is line return</span>
</span><span class='line'>    <span class="c1">// use the last line; otherwise put it back</span>
</span><span class='line'>    <span class="c1">// into the buffer to be completed later</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;\n&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="nx">buffer</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
</span><span class='line'>    <span class="c1">// process the remaining lines one at a time</span>
</span><span class='line'>    <span class="nx">lines</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">processLine</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">buffer</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">http_options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">buffer</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">checkForData</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">checkForData</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">watcher</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Continuous watcher implementation</h3>

<p>I just inserted the code block above in the original
<code>watch_changes_skeleton.js</code>; no other modifications were required.</p>

<p>With the code block above, both the long polling and the continuous
outputs are identical.</p>

<h3>Conflicts view</h3>

<p>As I said above, conflicts are only created in the losing database, so
to test this I must use the <code>music-repl</code> database.</p>

<p>Otherwise, the code is simple: iterate on the <code>_conflicts</code> attribute,
and for each revision it contains, emit that revision mapped to the
document <code>_id</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;_design/conflicts&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;4-1f5c35d83a4cfc7783d60f665946dc6d&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;language&quot;</span><span class="o">:</span> <span class="s2">&quot;javascript&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;views&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>       <span class="s2">&quot;conflicts&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>           <span class="s2">&quot;map&quot;</span><span class="o">:</span> <span class="s2">&quot;function(doc) { (doc._conflicts || []).forEach(function(rev) { emit(rev, doc._id); }); }&quot;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Testing it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://localhost:5984/music-repl/_design/conflicts/_view/conflicts | python -mjson.tool
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100   129    0   129    0     0  37478      0 --:--:-- --:--:-- --:--:-- 64500
</span><span class='line'>{
</span><span class='line'>    "offset": 0, 
</span><span class='line'>    "rows": [
</span><span class='line'>        {
</span><span class='line'>            "id": "theconflicts", 
</span><span class='line'>            "key": "2-0c969fbfa76eb7fcdf6412ef219fcac5", 
</span><span class='line'>            "value": "theconflicts"
</span><span class='line'>        }
</span><span class='line'>    ], 
</span><span class='line'>    "total_rows": 1
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>And this completes Day 3 and this overview of CouchDB.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Frédéric Dumont</span></span>

      








  


<time datetime="2012-02-01T18:06:00+09:00" pubdate data-updated="true">Feb 1<span>st</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/books/'>Books</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.wakatta.jp/blog/2012/02/01/seven-databases-in-seven-weeks-couchdb-day-3/" data-via="" data-counturl="http://blog.wakatta.jp/blog/2012/02/01/seven-databases-in-seven-weeks-couchdb-day-3/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/01/30/seven-databases-in-seven-weeks-couchdb-day-2/" title="Previous Post: Seven Databases in Seven Weeks CouchDB Day 2">&laquo; Seven Databases in Seven Weeks CouchDB Day 2</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/02/05/concrete-mathematics-chapter-1-exam-problems/" title="next Post: Concrete Mathematics Chapter 1 Exam Problems">Concrete Mathematics Chapter 1 Exam Problems &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Wakatta!</h1>
  <p>
		<a href="/about">more...</a>
	</p>
</section>

<section>
	<h1>Seven Databases in Seven Weeks Series</h1>
	
		<ul>
		
			<li class="post"><a href="/blog/2011/12/03/new-book-seven-databases-in-seven-weeks/">Intro</a></li>
		
			<li class="post"><a href="/blog/2011/12/03/seven-databases-in-seven-weeks-postgresql-day-1/">PostgreSQL Day 1</a></li>
		
			<li class="post"><a href="/blog/2011/12/03/seven-databases-in-seven-weeks-postgresql-day-2/">PostgreSQL Day 2</a></li>
		
			<li class="post"><a href="/blog/2011/12/04/seven-databases-in-seven-weeks-postgresql-day-3/">PostgreSQL Day 3</a></li>
		
			<li class="post"><a href="/blog/2011/12/08/seven-databases-in-seven-weeks-riak-day-1/">Riak Day 1</a></li>
		
			<li class="post"><a href="/blog/2011/12/08/seven-databases-in-seven-weeks-riak-day-2/">Riak Day 2</a></li>
		
			<li class="post"><a href="/blog/2011/12/09/seven-databases-in-seven-weeks-riak-day-3/">Riak Day 3</a></li>
		
			<li class="post"><a href="/blog/2011/12/11/seven-databases-in-seven-weeks-hbase-day-1/">HBase Day 1</a></li>
		
			<li class="post"><a href="/blog/2011/12/12/seven-databases-in-seven-weeks-hbase-day-2/">HBase Day 2</a></li>
		
			<li class="post"><a href="/blog/2011/12/15/seven-databases-in-seven-weeks-hbase-day-3/">HBase Day 3</a></li>
		
			<li class="post"><a href="/blog/2011/12/17/seven-databases-in-seven-weeks-riak-on-ec2/">Riak on EC2</a></li>
		
			<li class="post"><a href="/blog/2011/12/23/seven-databases-in-seven-weeks-mongodb-day-1/">MongoDB Day 1</a></li>
		
			<li class="post"><a href="/blog/2011/12/24/seven-databases-in-seven-weeks-mongodb-day-2/">MongoDB Day 2</a></li>
		
			<li class="post"><a href="/blog/2011/12/25/seven-databases-in-seven-weeks-mongodb-day-3/">MongoDB Day 3</a></li>
		
			<li class="post"><a href="/blog/2011/12/28/seven-databases-in-seven-weeks-neo4j-day-1/">Neo4j Day 1</a></li>
		
			<li class="post"><a href="/blog/2011/12/29/seven-databases-in-seven-weeks-neo4j-day-2/">Neo4j Day 2</a></li>
		
			<li class="post"><a href="/blog/2011/12/30/seven-databases-in-seven-weeks-neo4j-day-3/">Neo4j Day 3</a></li>
		
			<li class="post"><a href="/blog/2012/01/20/seven-databases-in-seven-weeks-redis-day-1/">Redis Day 1</a></li>
		
			<li class="post"><a href="/blog/2012/01/21/seven-databases-in-seven-weeks-redis-day-2/">Redis Day 2</a></li>
		
			<li class="post"><a href="/blog/2012/01/30/seven-databases-in-seven-weeks-couchdb-day-1/">CouchDB Day 1</a></li>
		
			<li class="post"><a href="/blog/2012/01/30/seven-databases-in-seven-weeks-couchdb-day-2/">CouchDB Day 2</a></li>
		
			<li class="post"><a href="/blog/2012/02/01/seven-databases-in-seven-weeks-couchdb-day-3/">CouchDB Day 3</a></li>
		
			<li class="post"><a href="/blog/2012/03/14/seven-databases-in-seven-weeks-redis-day-3/">Redis Day 3</a></li>
		
			<li class="post"><a href="/blog/2012/03/15/seven-databases-in-seven-weeks-wrapping-up/">Wrapping Up</a></li>
		
			<li class="post"><a href="/blog/2012/05/02/now-im-blushing-dot-dot-dot/">Now I'm blushing...</a></li>
		
		</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/05/02/now-im-blushing-dot-dot-dot/">Now I'm blushing...</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/02/concrete-mathematics-chapter-2-homework-exercises/">Concrete Mathematics Chapter 2 Homework Exercises</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/09/machine-learning-in-action-naive-bayes/">Machine Learning in Action - Naïve Bayes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/15/seven-databases-in-seven-weeks-wrapping-up/">Seven Databases in Seven Weeks Wrapping Up</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/14/seven-databases-in-seven-weeks-redis-day-3/">Seven Databases in Seven Weeks Redis Day 3</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/fdumontmd">@fdumontmd</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'fdumontmd',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Frédéric Dumont -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>
  
  </span>
</p>

</footer>
  

<div class="tex2jax_ignore">
<script type="text/javascript">
      var disqus_shortname = 'wakatta-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.wakatta.jp/blog/2012/02/01/seven-databases-in-seven-weeks-couchdb-day-3/';
        var disqus_url = 'http://blog.wakatta.jp/blog/2012/02/01/seven-databases-in-seven-weeks-couchdb-day-3/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>
</div>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
