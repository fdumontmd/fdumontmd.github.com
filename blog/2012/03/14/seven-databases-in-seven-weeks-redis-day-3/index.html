
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Seven Databases in Seven Weeks Redis Day 3 - Wakatta!</title>
  <meta name="author" content="Frédéric Dumont">

  
  <meta name="description" content="Wow, almost two months since I wrote
Day 2,
and more than one since the last post in this series&#8230; Time to bring
it to an end. Today is less &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.wakatta.jp/blog/2012/03/14/seven-databases-in-seven-weeks-redis-day-3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Wakatta!" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">



  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26245052-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Wakatta!</a></h1>
  
    <h2>Like Eureka!, only cooler</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.wakatta.jp" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Seven Databases in Seven Weeks Redis Day 3</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-14T15:48:00+09:00" pubdate data-updated="true">Mar 14<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Wow, almost two months since I wrote
<a href="/blog/2012/01/21/seven-databases-in-seven-weeks-redis-day-2/">Day 2</a>,
and more than one since the last post in this series&#8230; Time to bring
it to an end.</p>

<!--more-->


<p>Today is less about Redis (indeed, it is hardly used at all), and more
about a concept: Polyglot Persistence, and about an implementation
that showcases the concept.</p>

<p>In fact, I spent most of my time browsing the documentation of
<a href="http://nodejs.org/">Node.js</a>, the library/framework the authors used
to build the demo application.</p>

<h2>Polyglot Persistence</h2>

<p>Polyglot Persistence, the use of several kinds of storage systems in a
project, makes even more sense than Polyglot Programming (the
use of several languages in a project).</p>

<p>While languages are, by and large, equivalent in expressive power, and
mostly a matter of choice, culture, or comparative advantage (some
languages favour small teams, other large ones), storage systems are
sufficiently different that they are not interchangeable.</p>

<p>Once the idea of eventual consistency takes root, it is only a simple
extension to view the data as services available from a number of
sources, each optimised for its intended use (instead of a single,
default source that only partially meets the more specialised needs),
and with its own update cycles.</p>

<p>The problem, of course, is that it introduces several levels of
complexity: development, deployment, monitoring, and a dizzying range
of potential errors, failures, &#8230;</p>

<h2>Polyglot Persistent Service</h2>

<p>The implementation described in the book is small enough to fit in
less than 15 pages, yet rich enough to show what is possible.</p>

<p>The databases are (with the versions I used):</p>

<ul>
<li>Redis 2.4.8</li>
<li>CouchDB 1.1.1</li>
<li>Neo4j Community 1.6.1</li>
</ul>


<p>and the glue language is Node.js.</p>

<h3>Redis</h3>

<p>Redis is used first as initial storage for the first data take-on. It
is then used to track the transfer of data between CouchDB and the
other databases, and finally to support auto-completion of band names.</p>

<h3>CouchDB</h3>

<p>CouchDB is intended as the System Of Records (i.e. master database)
for the system. Data is meant to be loaded into CouchDB first, then
propagated to the other databases.</p>

<p>Beside that, it is not used much, and after the exercises, not used at all&#8230;</p>

<h3>Neo4j</h3>

<p>Neo4j keeps a graph of bands, members, and instruments (or roles), and
their relationships.</p>

<h3>Node.js</h3>

<p>Node.js is a framework/library for JavaScript based on the concept of
event-based programming (similar to, but perhaps more radical than,
Erlang). All I/O is done in continuation-passing style, which means
that whenever a I/O operation is initiated, one of the argument is a
function to handle whatever the operation produces (or deal with the
errors).</p>

<p>This is good from a performance point of view, but it is of course
more complex to design and code with. Still, it looks like a fun tool
to glue various servers together.</p>

<h3>Book Code Fixes</h3>

<p>I had to fix some of the code from the authors (nothing serious, and
all reported in the <a href="http://pragprog.com/titles/rwdata/errata">errata</a>):</p>

<ul>
<li><code>populate_couch.js</code>: the <code>trackLineCount</code> has an off-by-one
error. The check for completion should be <code>totalBands &lt;=
processedBands</code></li>
<li><code>bands.js</code>: the initialisation of <code>membersQuery</code> in the function
for the <code>/band</code> route has a syntax error. It should be</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>membersQuery = 'g.V[[name:"'+bandName+'"]]' 
</span><span class='line'>             + '.out("member").in("member").uniqueObject.name';</span></code></pre></td></tr></table></div></figure>


<h3>Updating the Code</h3>

<p>The book uses a now dated version of Neo4j, so the queries do not
work. The shortcut to access a node by index does not work anymore,
and the <code>uniqueObject</code> step has been replaced by <code>dedup</code>.</p>

<p>Here are the updated relevant portions:</p>

<figure class='code'><figcaption><span>/band Route  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">membersQuery</span> <span class="o">=</span> <span class="s1">&#39;g.idx(&quot;bands&quot;)[[&quot;name&quot;:&quot;&#39;</span><span class="o">+</span><span class="nx">bandName</span><span class="o">+</span><span class="s1">&#39;&quot;]]&#39;</span>
</span><span class='line'>             <span class="o">+</span> <span class="s1">&#39;.out(&quot;member&quot;).in(&quot;member&quot;).dedup.name&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>and</p>

<figure class='code'><figcaption><span>/artist Route  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">rolesQuery</span> <span class="o">=</span> <span class="s1">&#39;g.idx(&quot;artists&quot;)[[&quot;name&quot;:&quot;&#39;</span><span class="o">+</span><span class="nx">artistName</span><span class="o">+</span><span class="s1">&#39;&quot;]].out(&quot;plays&quot;).role.dedup&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">bandsQuery</span> <span class="o">=</span> <span class="s1">&#39;g.idx(&quot;artists&quot;)[[&quot;name&quot;:&quot;&#39;</span><span class="o">+</span><span class="nx">artistName</span><span class="o">+</span><span class="s1">&#39;&quot;]].in(&quot;member&quot;).name.dedup&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Exercises</h2>

<p>I&#8217;m not sure what the second homework exercise was supposed to be
about: Neo4j already contains information about members and
memberships. Perhaps it dates from an early draft, before this
chapter&#8217;s code evolved into what it is now. In any case, the first
exercise had enough Neo4j anyway.</p>

<h3>Adding Band Member&#8217;s start and end dates</h3>

<p>The start and end dates for memberships in bands is sometimes
provided; the purpose of this exercise is to use this information.</p>

<h4>Pre-populate</h4>

<p>I load the start and end dates into their own key in Redis. The key
format are <code>from:bandName:artistName</code> and <code>to:bandName:artistName</code>.</p>

<p>First I take the data from the relevant columns:</p>

<figure class='code'><figcaption><span>Extracting Data  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span>
</span><span class='line'>  <span class="nx">artist</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span class='line'>  <span class="nx">band</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span class='line'>  <span class="nx">roles</span> <span class="o">=</span> <span class="nx">buildRoles</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
</span><span class='line'>  <span class="nx">from</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
</span><span class='line'>  <span class="nx">to</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, if they&#8217;re not empty, I create the keys in Redis:</p>

<figure class='code'><figcaption><span>Updating Redis  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">from</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">redis_client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;from:&#39;</span> <span class="o">+</span> <span class="nx">band</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">artist</span><span class="p">,</span> <span class="nx">from</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">to</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">redis_client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;to:&#39;</span> <span class="o">+</span> <span class="nx">band</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">artist</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>CouchDB</h4>

<p>Adding the information to CouchDB is not hard; the main difficulty is
to figure out how to modify the <code>populate_couch.js</code> script
(continuation-passing style is <em>hard</em>).</p>

<p>Eventually, I just reused the <code>roleBatch</code> (therefore renamed
<code>artistInfoBatch</code>) to retrieve the roles, from and to information.</p>

<figure class='code'><figcaption><span>Retrieving the Information  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">artistInfoBatch</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'><span class="nx">artists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">artistName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">artistInfoBatch</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
</span><span class='line'>    <span class="s1">&#39;smembers&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;artist:&#39;</span> <span class="o">+</span> <span class="nx">bandName</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">artistName</span>
</span><span class='line'>  <span class="p">]);</span>
</span><span class='line'>  <span class="nx">artistInfoBatch</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
</span><span class='line'>    <span class="s1">&#39;get&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;from:&#39;</span> <span class="o">+</span> <span class="nx">bandName</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">artistName</span>
</span><span class='line'>  <span class="p">]);</span>
</span><span class='line'>  <span class="nx">artistInfoBatch</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
</span><span class='line'>    <span class="s1">&#39;get&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;to:&#39;</span> <span class="o">+</span> <span class="nx">bandName</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">artistName</span>
</span><span class='line'>  <span class="p">]);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>The putting it in CouchDB is trivial:</p>

<figure class='code'><figcaption><span>Building Documents  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">artists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">artistName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">artist</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">artistName</span><span class="p">,</span> <span class="nx">role</span> <span class="o">:</span> <span class="nx">artistInfo</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="p">},</span>
</span><span class='line'>      <span class="nx">from</span> <span class="o">=</span> <span class="nx">artistInfo</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">],</span>
</span><span class='line'>      <span class="nx">to</span> <span class="o">=</span> <span class="nx">artistInfo</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">from</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">artist</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">to</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">artist</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">artistDocs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">artist</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Neo4j</h4>

<p>Neo4j was the hardest piece of the puzzle: I didn&#8217;t know, and could
not find any definitive documentation on, how to relationship
properties at creation time. Eventually I found that adding them to
the <code>data</code> attribute passed at creation time did the trick (although
it still took me more time to understand how to use them).</p>

<p>The problem to do so is that the <code>neo4j_caching_client.js</code> library
does not support adding properties to relationships, but it was easy
enough to modify this library to add this feature.</p>

<figure class='code'><figcaption><span>Relationship properties  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">createRelationship</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fromNode</span><span class="p">,</span> <span class="nx">toNode</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">fromPath</span> <span class="o">=</span> <span class="p">(</span><span class="nx">fromNode</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^.*?\/db\/data\//</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span><span class='line'>      <span class="nx">rel</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">toNode</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span> <span class="p">};</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">rel</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span>
</span><span class='line'>    <span class="p">[</span><span class="nx">fromPath</span><span class="p">,</span> <span class="s1">&#39;relationships&#39;</span><span class="p">],</span> <span class="nx">rel</span><span class="p">,</span> <span class="nx">callback</span>
</span><span class='line'>  <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>then the relevant properties can be passed to the function above in
the <code>graph_sync.js</code> script:</p>

<figure class='code'><figcaption><span>Passing from and to properties  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'><span class="nx">progress</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="s1">&#39;artist&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">artist</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">props</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">artist</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">artist</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">props</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">artist</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
</span><span class='line'><span class="nx">relate</span><span class="p">(</span><span class="nx">bandNode</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="nx">artistNode</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="s1">&#39;member&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">progress</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="s1">&#39;member&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">},</span> <span class="nx">props</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Using the new data</h4>

<p>To make use of the new data, I tried to differentiate between current
and old members of a band. I simply define a current member as one
whose <code>to</code> property is null.</p>

<p>Figuring how to write a Gremlin query that extracted the information I
needed was challenging: the documentation is often sparse, and many
concepts barely explained.</p>

<p>I found that I could collect nodes or relationships along a path by
naming them (with the step <code>as</code>), and then gather all of them in a
single row of a
<a href="http://docs.neo4j.org/chunked/stable/gremlin-plugin.html#rest-api-returning-nested-pipes"><code>Table</code></a>.
I used this to get both the <code>from</code>, <code>to</code>
properties and the artist <code>name</code> property in a single query. However,
I spent some time tracking a bug in my filters where apparently, null
<code>to</code> would not be returned as current members. I finally realise that
when a given node or relationship is given two different names, these
names will appear in reverse order in the <code>Table</code>.</p>

<p>So in my case, the query:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>g.idx("bands")[["name":"Nine Inch Nails"]].outE("member").as("from").as("to")
</span><span class='line'>.filter{it.to != null}.inV.as("name")
</span><span class='line'>.table(new Table()).{it.to}{it.from}{it.name}.cap()</span></code></pre></td></tr></table></div></figure>


<p>I give the names <code>from</code> and <code>to</code> to the relationship, but used them in
reverse order in the <code>Table</code> closures. Is this the intended behaviour
or a bug? Does anybody know?</p>

<p>It seems like a common problem with some NoSQL databases: the query
language feels very much adhoc, and not entirely sound or fully
thought through. Despite its many defects, SQL was at least based (if
sometimes remotely) on the relational calculus, which gave a precise
meaning to queries. It was further specified in different standards,
so that even its defects were fully clarified (XPath/XQuery is another
pretty well specified query language). When playing with NoSQL
databases that pretend to have a query language, I often find it
difficult to go beyond the simpler examples, precisely because of this
linguistic fuzziness.</p>

<p>But I solved it for this case, so now I have my <code>Table</code>. It is an
object with two properties: <code>columns</code> is an array of column names, and
<code>data</code> is an array of arrays (each one being a row). To convert them
to an array of objects, I use the following code:</p>

<figure class='code'><figcaption><span>Convert Table data  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">convertGremlinTable</span><span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">fromTableToObject</span><span class="p">(</span><span class="nx">table</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">columns</span><span class="p">,</span> <span class="nx">table</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">fromTableToObject</span><span class="p">(</span><span class="nx">columns</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">columns</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="nx">obj</span><span class="p">[</span><span class="nx">columns</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The rest of the code is just the nested Node.js event functions, and
the formatting using the <a href="http://mustache.github.com/"><code>mustache</code></a>
(which was pretty cool and easy to use).</p>

<h4>Full Code</h4>

<figure class='code'><figcaption><span> (pre_populate.js)</span> <a href='/downloads/code/7d7w/redis/day3/from-to/pre_populate.js'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/***</span>
</span><span class='line'><span class="cm"> * Excerpted from &quot;Seven Databases in Seven Weeks&quot;,</span>
</span><span class='line'><span class="cm"> * published by The Pragmatic Bookshelf.</span>
</span><span class='line'><span class="cm"> * Copyrights apply to this code. It may not be used to create training material, </span>
</span><span class='line'><span class="cm"> * courses, books, articles, and the like. Contact us if you are in doubt.</span>
</span><span class='line'><span class="cm"> * We make no guarantees that this code is fit for any purpose. </span>
</span><span class='line'><span class="cm"> * Visit http://www.pragmaticprogrammer.com/titles/rwdata for more book information.</span>
</span><span class='line'><span class="cm">***/</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span>
</span><span class='line'>  <span class="c1">// The band data file name in tab-seperated form</span>
</span><span class='line'>  <span class="nx">tsvFileName</span> <span class="o">=</span> <span class="s1">&#39;group_membership.tsv&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">// track how many file lines we&#39;ve processed</span>
</span><span class='line'>  <span class="nx">processedLines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// standard libraries</span>
</span><span class='line'>  <span class="nx">csv</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// database clients</span>
</span><span class='line'>  <span class="nx">redis_client</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="mi">6379</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * A helper function that splits up the comma-seperated list of roles and</span>
</span><span class='line'><span class="cm"> * converts it to an array. If no valid roles exist, return an empty array.</span>
</span><span class='line'><span class="cm"> * @param string the CSV to split into a role array</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">buildRoles</span><span class="p">(</span> <span class="nx">string</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">roles</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">roles</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">roles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="nx">roles</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">roles</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Utility function that increments the total number</span>
</span><span class='line'><span class="cm"> * of lines (artists) processed and outputs every 1000.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">trackLineCount</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="o">++</span><span class="nx">processedLines</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Lines Processed: &#39;</span> <span class="o">+</span> <span class="nx">processedLines</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Does all heavy lifting. Loops through the CSV file</span>
</span><span class='line'><span class="cm"> * and populate Redis with the given values.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">populateRedis</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">csv</span><span class="p">().</span>
</span><span class='line'>  <span class="nx">fromPath</span><span class="p">(</span> <span class="nx">tsvFileName</span><span class="p">,</span> <span class="p">{</span> <span class="nx">delimiter</span><span class="o">:</span> <span class="s1">&#39;\t&#39;</span><span class="p">,</span> <span class="nx">quote</span><span class="o">:</span> <span class="s1">&#39;&#39;</span> <span class="p">}).</span>
</span><span class='line'>  <span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span>
</span><span class='line'>      <span class="nx">artist</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span class='line'>      <span class="nx">band</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span class='line'>      <span class="nx">roles</span> <span class="o">=</span> <span class="nx">buildRoles</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
</span><span class='line'>      <span class="nx">from</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
</span><span class='line'>      <span class="nx">to</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="nx">band</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="nx">artist</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">trackLineCount</span><span class="p">();</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">redis_client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;band:&#39;</span> <span class="o">+</span> <span class="nx">band</span><span class="p">,</span> <span class="nx">artist</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">roles</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">role</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">redis_client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="s1">&#39;artist:&#39;</span> <span class="o">+</span> <span class="nx">band</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">artist</span><span class="p">,</span> <span class="nx">role</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">from</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">redis_client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;from:&#39;</span> <span class="o">+</span> <span class="nx">band</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">artist</span><span class="p">,</span> <span class="nx">from</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">to</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">redis_client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;to:&#39;</span> <span class="o">+</span> <span class="nx">band</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">artist</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">trackLineCount</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}).</span>
</span><span class='line'>  <span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">total_lines</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Total Lines Processed: &#39;</span> <span class="o">+</span> <span class="nx">processedLines</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">redis_client</span><span class="p">.</span><span class="nx">quit</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">populateRedis</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span> (populate_couch.js)</span> <a href='/downloads/code/7d7w/redis/day3/from-to/populate_couch.js'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/***</span>
</span><span class='line'><span class="cm"> * Excerpted from &quot;Seven Databases in Seven Weeks&quot;,</span>
</span><span class='line'><span class="cm"> * published by The Pragmatic Bookshelf.</span>
</span><span class='line'><span class="cm"> * Copyrights apply to this code. It may not be used to create training material, </span>
</span><span class='line'><span class="cm"> * courses, books, articles, and the like. Contact us if you are in doubt.</span>
</span><span class='line'><span class="cm"> * We make no guarantees that this code is fit for any purpose. </span>
</span><span class='line'><span class="cm"> * Visit http://www.pragmaticprogrammer.com/titles/rwdata for more book information.</span>
</span><span class='line'><span class="cm">***/</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span>
</span><span class='line'>  <span class="c1">// how many bands we expect to process</span>
</span><span class='line'>  <span class="nx">totalBands</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">// and keep track of how many bands we have processed</span>
</span><span class='line'>  <span class="nx">processedBands</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">// The name of the couch database</span>
</span><span class='line'>  <span class="nx">couchDBpath</span> <span class="o">=</span> <span class="s1">&#39;/bands&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// standard libraries</span>
</span><span class='line'>  <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// database clients</span>
</span><span class='line'>  <span class="nx">couchClient</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="mi">5984</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">redisClient</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="mi">6379</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * A helper function that builds a good CouchDB key</span>
</span><span class='line'><span class="cm"> * @param string the unicode string being keyified</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">couchKeyify</span><span class="p">(</span> <span class="nx">string</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// remove bad chars, and disallow starting with an underscore</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">string</span><span class="p">.</span>
</span><span class='line'>    <span class="nx">replace</span><span class="p">(</span><span class="sr">/[\t \?\#\\\-\+\.\,&#39;&quot;()*&amp;!\/]+/g</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">).</span>
</span><span class='line'>    <span class="nx">replace</span><span class="p">(</span><span class="sr">/^_+/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Keep track of the number of bands processed, output every 1000 loaded,</span>
</span><span class='line'><span class="cm"> * and close the Redis client when we&#39;ve loaded them all.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">trackLineCount</span><span class="p">(</span> <span class="nx">increment</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">processedBands</span> <span class="o">+=</span> <span class="nx">increment</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// output once every 1000 lines</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">processedBands</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Bands Loaded: &#39;</span> <span class="o">+</span> <span class="nx">processedBands</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// close the Redis Client when complete</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">totalBands</span> <span class="o">&lt;=</span> <span class="nx">processedBands</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Total Bands Loaded: &#39;</span> <span class="o">+</span> <span class="nx">processedBands</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">redisClient</span><span class="p">.</span><span class="nx">quit</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Post one or more documents into CouchDB.</span>
</span><span class='line'><span class="cm"> * @param url is where we POST to.</span>
</span><span class='line'><span class="cm"> * @param docString a stringified JSON document.</span>
</span><span class='line'><span class="cm"> * @param count the number of documents being inserted.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">postDoc</span><span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">docsString</span><span class="p">,</span> <span class="nx">count</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">couchClient</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">url</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span> <span class="o">:</span> <span class="s1">&#39;application/json&#39;</span> <span class="p">});</span>
</span><span class='line'>  <span class="nx">request</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span> <span class="nx">docsString</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">request</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">201</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">trackLineCount</span><span class="p">(</span> <span class="nx">count</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">}).</span>
</span><span class='line'>  <span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;postDoc Got error: &#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Loop through all of the bands populated in Redis. We expect</span>
</span><span class='line'><span class="cm"> * the format of each key to be &#39;band:Band Name&#39; having the value</span>
</span><span class='line'><span class="cm"> * as a set of artist names. The artists each have the list of roles</span>
</span><span class='line'><span class="cm"> * they play in each band, keyed by &#39;artist:Band Name:Artist Name&#39;.</span>
</span><span class='line'><span class="cm"> * The band name, set of artists, and set of roles each artist plays</span>
</span><span class='line'><span class="cm"> * populates the CouchDB documents. eg:</span>
</span><span class='line'><span class="cm">  {</span>
</span><span class='line'><span class="cm">    name:&quot;Nirvana&quot;,</span>
</span><span class='line'><span class="cm">    artists:[{</span>
</span><span class='line'><span class="cm">      name: &quot;Kurt Cobain&quot;,</span>
</span><span class='line'><span class="cm">      roles:[&quot;Lead Vocals&quot;, &quot;Guitar&quot;]</span>
</span><span class='line'><span class="cm">    },...]</span>
</span><span class='line'><span class="cm">  }</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">populateBands</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// First, create the couch database</span>
</span><span class='line'>  <span class="nx">couchClient</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="nx">couchDBpath</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">redisClient</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="s1">&#39;band:*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">bandKeys</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">totalBands</span> <span class="o">=</span> <span class="nx">bandKeys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span>
</span><span class='line'>      <span class="nx">readBands</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">bandsBatch</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">bandKeys</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">bandKey</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// substring of &#39;band:&#39;.length gives us the band name</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">bandName</span> <span class="o">=</span> <span class="nx">bandKey</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">redisClient</span><span class="p">.</span><span class="nx">smembers</span><span class="p">(</span><span class="nx">bandKey</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">artists</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// batch the Redis calls to get all artists&#39; information at once</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">artistInfoBatch</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>        <span class="nx">artists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">artistName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">artistInfoBatch</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
</span><span class='line'>            <span class="s1">&#39;smembers&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;artist:&#39;</span> <span class="o">+</span> <span class="nx">bandName</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">artistName</span>
</span><span class='line'>          <span class="p">]);</span>
</span><span class='line'>          <span class="nx">artistInfoBatch</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
</span><span class='line'>            <span class="s1">&#39;get&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;from:&#39;</span> <span class="o">+</span> <span class="nx">bandName</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">artistName</span>
</span><span class='line'>          <span class="p">]);</span>
</span><span class='line'>          <span class="nx">artistInfoBatch</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
</span><span class='line'>            <span class="s1">&#39;get&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;to:&#39;</span> <span class="o">+</span> <span class="nx">bandName</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">artistName</span>
</span><span class='line'>          <span class="p">]);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// batch up each band member to find the roles they play</span>
</span><span class='line'>        <span class="nx">redisClient</span><span class="p">.</span>
</span><span class='line'>          <span class="nx">multi</span><span class="p">(</span><span class="nx">artistInfoBatch</span><span class="p">).</span>
</span><span class='line'>          <span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">artistInfo</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span>
</span><span class='line'>              <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>              <span class="nx">artistDocs</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// build the artists sub-documents</span>
</span><span class='line'>            <span class="nx">artists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">artistName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">artist</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">artistName</span><span class="p">,</span> <span class="nx">role</span> <span class="o">:</span> <span class="nx">artistInfo</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="p">},</span>
</span><span class='line'>                  <span class="nx">from</span> <span class="o">=</span> <span class="nx">artistInfo</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">],</span>
</span><span class='line'>                  <span class="nx">to</span> <span class="o">=</span> <span class="nx">artistInfo</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">];</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="nx">from</span><span class="p">)</span>
</span><span class='line'>                <span class="nx">artist</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="nx">to</span><span class="p">)</span>
</span><span class='line'>                <span class="nx">artist</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
</span><span class='line'>              <span class="nx">artistDocs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">artist</span><span class="p">);</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// add this new band document to the batch to be executed later</span>
</span><span class='line'>            <span class="nx">bandsBatch</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span><span class='line'>              <span class="nx">_id</span><span class="o">:</span> <span class="nx">couchKeyify</span><span class="p">(</span> <span class="nx">bandName</span> <span class="p">),</span>
</span><span class='line'>              <span class="nx">name</span><span class="o">:</span> <span class="nx">bandName</span><span class="p">,</span>
</span><span class='line'>              <span class="nx">artists</span><span class="o">:</span> <span class="nx">artistDocs</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>            <span class="c1">// keep track of the total number of bands read</span>
</span><span class='line'>            <span class="nx">readBands</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// upload batches of 50 values to couch, or the remaining values left</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span> <span class="nx">bandsBatch</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">50</span> <span class="o">||</span> <span class="nx">totalBands</span> <span class="o">-</span> <span class="nx">readBands</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">postDoc</span><span class="p">(</span>
</span><span class='line'>                <span class="nx">couchDBpath</span><span class="o">+</span><span class="s1">&#39;/_bulk_docs&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">docs</span> <span class="o">:</span> <span class="nx">bandsBatch</span> <span class="p">}),</span>
</span><span class='line'>                <span class="nx">bandsBatch</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="c1">// empty out the batch array to be filled again</span>
</span><span class='line'>              <span class="nx">bandsBatch</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// expose couchKeyify function</span>
</span><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">couchKeyify</span> <span class="o">=</span> <span class="nx">couchKeyify</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// start populating bands if running as main script</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">module</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">populateBands</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span> (graph_sync.js)</span> <a href='/downloads/code/7d7w/redis/day3/from-to/graph_sync.js'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/***</span>
</span><span class='line'><span class="cm"> * Excerpted from &quot;Seven Databases in Seven Weeks&quot;,</span>
</span><span class='line'><span class="cm"> * published by The Pragmatic Bookshelf.</span>
</span><span class='line'><span class="cm"> * Copyrights apply to this code. It may not be used to create training material, </span>
</span><span class='line'><span class="cm"> * courses, books, articles, and the like. Contact us if you are in doubt.</span>
</span><span class='line'><span class="cm"> * We make no guarantees that this code is fit for any purpose. </span>
</span><span class='line'><span class="cm"> * Visit http://www.pragmaticprogrammer.com/titles/rwdata for more book information.</span>
</span><span class='line'><span class="cm">***/</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span>
</span><span class='line'>  <span class="c1">// standard libraries</span>
</span><span class='line'>  <span class="nx">events</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">esc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;querystring&#39;</span><span class="p">).</span><span class="nx">escape</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// custom libraries</span>
</span><span class='line'>  <span class="nx">couch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./watch_changes_continuous.js&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">neo4j</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./neo4j_caching_client.js&#39;</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// database clients</span>
</span><span class='line'>  <span class="nx">neo4jClient</span> <span class="o">=</span> <span class="nx">neo4j</span><span class="p">.</span><span class="nx">createClient</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">limit</span><span class="o">:</span> <span class="mi">10</span>
</span><span class='line'>  <span class="p">}),</span>
</span><span class='line'>  <span class="nx">couchWatcher</span> <span class="o">=</span> <span class="nx">couch</span><span class="p">.</span><span class="nx">createWatcher</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">db</span><span class="o">:</span> <span class="s1">&#39;bands&#39;</span>
</span><span class='line'>  <span class="p">}),</span>
</span><span class='line'>  <span class="nx">redisClient</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="mi">6379</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// feed band information into redis for autocompleter</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">feedBandToRedis</span><span class="p">(</span><span class="nx">band</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">redisClient</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;band-name:&#39;</span> <span class="o">+</span> <span class="nx">band</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">band</span><span class="p">.</span><span class="nx">artists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">artist</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">redisClient</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;artist-name:&#39;</span> <span class="o">+</span> <span class="nx">artist</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">artist</span><span class="p">.</span><span class="nx">role</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">role</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">redisClient</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;role-name:&#39;</span> <span class="o">+</span> <span class="nx">role</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * feed band membership and artist/role content from couch to neo4j.</span>
</span><span class='line'><span class="cm"> * @param band A band document from CouchDB.</span>
</span><span class='line'><span class="cm"> * @param progress EventEmitter to emit progress events.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">feedBandToNeo4j</span><span class="p">(</span><span class="nx">band</span><span class="p">,</span> <span class="nx">progress</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span>
</span><span class='line'>    <span class="nx">lookup</span> <span class="o">=</span> <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">lookupOrCreateNode</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">relate</span> <span class="o">=</span> <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">createRelationship</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;bands&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nx">band</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bandNode</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">progress</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="s1">&#39;band&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">band</span><span class="p">.</span><span class="nx">artists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">artist</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;artists&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nx">artist</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">artistNode</span><span class="p">){</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>        <span class="nx">progress</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="s1">&#39;artist&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">artist</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span>
</span><span class='line'>          <span class="nx">props</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">artist</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">artist</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span>
</span><span class='line'>          <span class="nx">props</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">artist</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">relate</span><span class="p">(</span><span class="nx">bandNode</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="nx">artistNode</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="s1">&#39;member&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>          <span class="nx">progress</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="s1">&#39;member&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">},</span> <span class="nx">props</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">artist</span><span class="p">.</span><span class="nx">role</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">role</span><span class="p">){</span>
</span><span class='line'>          <span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="nx">role</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">roleNode</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">progress</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">relate</span><span class="p">(</span><span class="nx">artistNode</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="nx">roleNode</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="s1">&#39;plays&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>              <span class="nx">progress</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="s1">&#39;plays&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// process only interesting bands (ones with artists who have roles)</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">processBand</span><span class="p">(</span><span class="nx">band</span><span class="p">,</span> <span class="nx">progress</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// change this to true to process all bands</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">addBand</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">band</span><span class="p">.</span><span class="nx">artists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">artist</span><span class="p">){</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">artist</span><span class="p">.</span><span class="nx">role</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">addBand</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">addBand</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">feedBandToRedis</span><span class="p">(</span><span class="nx">band</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">feedBandToNeo4j</span><span class="p">(</span><span class="nx">band</span><span class="p">,</span> <span class="nx">progress</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// progress reporting measures (how much work has been done)</span>
</span><span class='line'><span class="kd">var</span>
</span><span class='line'>  <span class="nx">stats</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">doc</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">band</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">artist</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">member</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">plays</span><span class="o">:</span><span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>  <span class="nx">progress</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">(),</span>
</span><span class='line'>  <span class="nx">timer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">stats</span><span class="p">);</span>
</span><span class='line'>  <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">progress</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">stats</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">stats</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// start watching couch and processing bands as they come in</span>
</span><span class='line'><span class="nx">couchWatcher</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">progress</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">doc</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">processBand</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">progress</span><span class="p">);</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span> (neo4j_caching_client.js)</span> <a href='/downloads/code/7d7w/redis/day3/from-to/neo4j_caching_client.js'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/***</span>
</span><span class='line'><span class="cm"> * Excerpted from &quot;Seven Databases in Seven Weeks&quot;,</span>
</span><span class='line'><span class="cm"> * published by The Pragmatic Bookshelf.</span>
</span><span class='line'><span class="cm"> * Copyrights apply to this code. It may not be used to create training material, </span>
</span><span class='line'><span class="cm"> * courses, books, articles, and the like. Contact us if you are in doubt.</span>
</span><span class='line'><span class="cm"> * We make no guarantees that this code is fit for any purpose. </span>
</span><span class='line'><span class="cm"> * Visit http://www.pragmaticprogrammer.com/titles/rwdata for more book information.</span>
</span><span class='line'><span class="cm">***/</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span>
</span><span class='line'>  <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">events</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">esc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;querystring&#39;</span><span class="p">).</span><span class="nx">escape</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">neo4j</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./neo4j_driver.js&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">createClient</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span>
</span><span class='line'>    <span class="nx">neo4jClient</span> <span class="o">=</span> <span class="nx">neo4j</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="nx">options</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">redisClient</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(),</span>
</span><span class='line'>    <span class="nx">pending</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">pending</span><span class="p">.</span><span class="nx">setMaxListeners</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// unlimited</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">expiry</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">expiry</span> <span class="o">||</span> <span class="mi">300</span><span class="p">;</span> <span class="c1">// default 5 min</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Run a gremlin script against the server.</span>
</span><span class='line'>  <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">runGremlin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ext/GremlinPlugin/graphdb/execute_script&#39;</span><span class="p">];</span>
</span><span class='line'>    <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="p">{</span> <span class="nx">script</span> <span class="o">:</span> <span class="nx">script</span> <span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// lookup a key/value node by index.</span>
</span><span class='line'>  <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">lookupNode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;index/node&#39;</span><span class="p">,</span> <span class="nx">esc</span><span class="p">(</span><span class="nx">index</span><span class="p">),</span> <span class="nx">esc</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span> <span class="nx">esc</span><span class="p">(</span><span class="nx">value</span><span class="p">)];</span>
</span><span class='line'>    <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// create a key/value node and index it.</span>
</span><span class='line'>  <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">createNode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>    <span class="nx">input</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">uri</span><span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="nx">key</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span> <span class="p">};</span>
</span><span class='line'>      <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">post</span><span class="p">([</span><span class="s1">&#39;index/node&#39;</span><span class="p">,</span> <span class="nx">esc</span><span class="p">(</span><span class="nx">index</span><span class="p">)],</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// lookup a node or create/index and cache it</span>
</span><span class='line'>  <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">lookupOrCreateNode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span>
</span><span class='line'>      <span class="nx">cacheKey</span> <span class="o">=</span> <span class="s1">&#39;lookup:&#39;</span> <span class="o">+</span> <span class="nx">index</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">ex</span> <span class="o">=</span> <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">expiry</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// only one pending lookup for a given index/key/value allowed at a time</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pending</span><span class="p">.</span><span class="nx">listeners</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// check redis first</span>
</span><span class='line'>      <span class="nx">redisClient</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">text</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// found in redis cache, use it and refresh</span>
</span><span class='line'>          <span class="nx">pending</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">));</span>
</span><span class='line'>          <span class="nx">redisClient</span><span class="p">.</span><span class="nx">expire</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">ex</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// missed redis cache, lookup in neo4j index</span>
</span><span class='line'>          <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">lookupNode</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">list</span> <span class="o">&amp;&amp;</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="c1">// found in index, use it and cache</span>
</span><span class='line'>              <span class="nx">pending</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>              <span class="nx">redisClient</span><span class="p">.</span><span class="nx">setex</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">ex</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>              <span class="c1">// missed index, create it and cache it</span>
</span><span class='line'>              <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">createNode</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
</span><span class='line'>                <span class="nx">pending</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">redisClient</span><span class="p">.</span><span class="nx">setex</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">ex</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
</span><span class='line'>              <span class="p">});</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">pending</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// create a relationship between two nodes</span>
</span><span class='line'>  <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">createRelationship</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fromNode</span><span class="p">,</span> <span class="nx">toNode</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">fromPath</span> <span class="o">=</span> <span class="p">(</span><span class="nx">fromNode</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^.*?\/db\/data\//</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">rel</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">toNode</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span> <span class="p">};</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">rel</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span>
</span><span class='line'>      <span class="p">[</span><span class="nx">fromPath</span><span class="p">,</span> <span class="s1">&#39;relationships&#39;</span><span class="p">],</span> <span class="nx">rel</span><span class="p">,</span> <span class="nx">callback</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">neo4jClient</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span> (bands.js)</span> <a href='/downloads/code/7d7w/redis/day3/from-to/bands.js'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/***</span>
</span><span class='line'><span class="cm"> * Excerpted from &quot;Seven Databases in Seven Weeks&quot;,</span>
</span><span class='line'><span class="cm"> * published by The Pragmatic Bookshelf.</span>
</span><span class='line'><span class="cm"> * Copyrights apply to this code. It may not be used to create training material, </span>
</span><span class='line'><span class="cm"> * courses, books, articles, and the like. Contact us if you are in doubt.</span>
</span><span class='line'><span class="cm"> * We make no guarantees that this code is fit for any purpose. </span>
</span><span class='line'><span class="cm"> * Visit http://www.pragmaticprogrammer.com/titles/rwdata for more book information.</span>
</span><span class='line'><span class="cm">***/</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span>
</span><span class='line'>  <span class="nx">port</span> <span class="o">=</span> <span class="mi">8080</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">jsonHeader</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="s1">&#39;application/json&#39;</span><span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// standard libraries</span>
</span><span class='line'>  <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">bricks</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bricks&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">mustache</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mustache&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// custom libraries</span>
</span><span class='line'>  <span class="nx">couchUtil</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./populate_couch.js&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">neo4j</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./neo4j_caching_client.js&#39;</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// database clients</span>
</span><span class='line'>  <span class="nx">couchClient</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="mi">5984</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">neo4jClient</span> <span class="o">=</span> <span class="nx">neo4j</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(),</span>
</span><span class='line'>  <span class="nx">redisClient</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="mi">6379</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span>
</span><span class='line'>  <span class="nx">gremlin</span> <span class="o">=</span> <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">runGremlin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * A convenience function for wrapping the</span>
</span><span class='line'><span class="cm"> * reading of JSON reponse data chunks.</span>
</span><span class='line'><span class="cm"> * @param response A Node HTTP response object.</span>
</span><span class='line'><span class="cm"> * @param callback the function to populate and call on completion.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">processBuffer</span><span class="p">(</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">buffer</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">buffer</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">callback</span><span class="p">(</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Post one or more documents into CouchDB.</span>
</span><span class='line'><span class="cm"> * @param url is where we POST to.</span>
</span><span class='line'><span class="cm"> * @param docString a stringified JSON document.</span>
</span><span class='line'><span class="cm"> * @param count the number of documents being inserted.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">getCouchDoc</span><span class="p">(</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">httpResponse</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">couchClient</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">jsonHeader</span> <span class="p">);</span>
</span><span class='line'>  <span class="nx">request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">request</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!=</span> <span class="mi">200</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">writeTemplate</span><span class="p">(</span> <span class="nx">httpResponse</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Value not found&quot;</span> <span class="p">}</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">processBuffer</span><span class="p">(</span> <span class="nx">response</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">couchObj</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">callback</span><span class="p">(</span> <span class="nx">couchObj</span> <span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}).</span>
</span><span class='line'>  <span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;postDoc Got error: &#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Wraps a block of HTML with a standard template. HTML lives in template.html.</span>
</span><span class='line'><span class="cm"> * @innerHtml populates the body of the template</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">htmlTemplate</span><span class="p">(</span> <span class="nx">innerHtml</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">file_data</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span> <span class="s1">&#39;template.html&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span> <span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">file_data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;[[YIELD]]&quot;</span><span class="p">,</span> <span class="nx">innerHtml</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">writeTemplate</span><span class="p">(</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">innerHtml</span><span class="p">,</span> <span class="nx">values</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span> <span class="nx">mustache</span><span class="p">.</span><span class="nx">to_html</span><span class="p">(</span> <span class="nx">htmlTemplate</span><span class="p">(</span> <span class="nx">innerHtml</span> <span class="p">),</span> <span class="nx">values</span> <span class="p">));</span>
</span><span class='line'>  <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">convertGremlinTable</span><span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">fromTableToObject</span><span class="p">(</span><span class="nx">table</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">columns</span><span class="p">,</span> <span class="nx">table</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">fromTableToObject</span><span class="p">(</span><span class="nx">columns</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">columns</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="nx">obj</span><span class="p">[</span><span class="nx">columns</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// A Nodejs web app utility setup</span>
</span><span class='line'><span class="nx">appServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bricks</span><span class="p">.</span><span class="nx">appserver</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// attach request plugin to easily extract params</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;^/&quot;</span><span class="p">,</span> <span class="nx">appServer</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">request</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Just display a blank form if no band is given.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;^/$&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">writeTemplate</span><span class="p">(</span> <span class="nx">res</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Find a band&quot;</span> <span class="p">}</span> <span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Accepts a band name and displays all artists in the band.</span>
</span><span class='line'><span class="cm"> * Also displays a list of suggested bands where at least</span>
</span><span class='line'><span class="cm"> * one artist has played at one time.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Gremlin: aliases introduced for the same node and/or</span>
</span><span class='line'><span class="cm"> * relationship appear to be used in reverse order in</span>
</span><span class='line'><span class="cm"> * Tables.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;^/band$&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">bandName</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
</span><span class='line'>      <span class="nx">bandNodePath</span> <span class="o">=</span> <span class="s1">&#39;/bands/&#39;</span> <span class="o">+</span> <span class="nx">couchUtil</span><span class="p">.</span><span class="nx">couchKeyify</span><span class="p">(</span> <span class="nx">bandName</span> <span class="p">),</span>
</span><span class='line'>      <span class="nx">queryPrefix</span> <span class="o">=</span> <span class="s1">&#39;g.idx(&quot;bands&quot;)[[&quot;name&quot;:&quot;&#39;</span><span class="o">+</span><span class="nx">bandName</span><span class="o">+</span><span class="s1">&#39;&quot;]]&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">otherBandsQuery</span> <span class="o">=</span> <span class="nx">queryPrefix</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.out(&quot;member&quot;).in(&quot;member&quot;).dedup.name&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">currentMembersQuery</span> <span class="o">=</span> <span class="nx">queryPrefix</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.outE(&quot;member&quot;).as(&quot;from&quot;)&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.filter{it.to == null}.inV.as(&quot;name&quot;)&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.table(new Table()){it.from}{it.name}.cap()&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">otherMembersQuery</span> <span class="o">=</span> <span class="nx">queryPrefix</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.outE(&quot;member&quot;).as(&quot;from&quot;).as(&quot;to&quot;)&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.filter{it.to != null}.inV.as(&quot;name&quot;)&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.table(new Table())&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;{it.to}{it.from}{it.name}.cap()&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">gremlin</span><span class="p">(</span><span class="nx">otherBandsQuery</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">graphData</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">gremlin</span><span class="p">(</span><span class="nx">currentMembersQuery</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">currentMembers</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">gremlin</span><span class="p">(</span><span class="nx">otherMembersQuery</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">otherMembers</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">{</span><span class="nx">band</span><span class="o">:</span> <span class="nx">bandName</span><span class="p">,</span> <span class="nx">bands</span><span class="o">:</span> <span class="nx">graphData</span><span class="p">,</span>
</span><span class='line'>                             <span class="nx">currents</span><span class="o">:</span> <span class="nx">convertGremlinTable</span><span class="p">(</span><span class="nx">currentMembers</span><span class="p">),</span>
</span><span class='line'>                             <span class="nx">others</span><span class="o">:</span> <span class="nx">convertGremlinTable</span><span class="p">(</span><span class="nx">otherMembers</span><span class="p">)};</span>
</span><span class='line'>                <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="s1">&#39;&lt;h2&gt;Current {{band}} Band Members&lt;/h2&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">currentMembers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;ul&gt;{{#currents}}&#39;</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;&lt;a href=&quot;/artist?name={{name}}&quot;&gt;{{name}}&#39;</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{#from}} from {{from}}{{/from}}&lt;/a&gt;&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{/currents}}&#39;</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s2">&quot;&lt;p&gt;No current member (dead band?)&lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">otherMembers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h3&gt;Other members&lt;/h3&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;ul&gt;{{#others}}&#39;</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;&lt;a href=&quot;/artist?name={{name}}&quot;&gt;{{name}}&#39;</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{#from}} from {{from}}{{/from}}&#39;</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{#to}} to {{to}}{{/to}}&lt;/a&gt;&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{/others}}&lt;/ul&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h3&gt;You may also like&lt;/h3&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;ul&gt;{{#bands}}&#39;</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;&lt;a href=&quot;/band?name={{.}}&quot;&gt;{{.}}&lt;/a&gt;&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{/bands}}&lt;/ul&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                <span class="nx">writeTemplate</span><span class="p">(</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">values</span> <span class="p">);</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Accepts an artist name and displays band and role information</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;^/artist$&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">artistName</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">queryPrefix</span> <span class="o">=</span> <span class="s1">&#39;g.idx(&quot;artists&quot;)[[&quot;name&quot;:&quot;&#39;</span><span class="o">+</span><span class="nx">artistName</span><span class="o">+</span><span class="s1">&#39;&quot;]]&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">rolesQuery</span> <span class="o">=</span> <span class="nx">queryPrefix</span> <span class="o">+</span><span class="s1">&#39;.out(&quot;plays&quot;).role.dedup&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">bandsQuery</span> <span class="o">=</span> <span class="s1">&#39;g.idx(&quot;artists&quot;)[[&quot;name&quot;:&quot;&#39;</span><span class="o">+</span><span class="nx">artistName</span><span class="o">+</span><span class="s1">&#39;&quot;]]&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.inE(&quot;member&quot;).as(&quot;to&quot;).as(&quot;from&quot;).outV.as(&quot;name&quot;)&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.table(new Table()){it.from}{it.to}{it.name}.cap()&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">gremlin</span><span class="p">(</span> <span class="nx">rolesQuery</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">roles</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">gremlin</span><span class="p">(</span> <span class="nx">bandsQuery</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bands</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">artist</span><span class="o">:</span> <span class="nx">artistName</span><span class="p">,</span> <span class="nx">roles</span><span class="o">:</span> <span class="nx">roles</span><span class="p">,</span>
</span><span class='line'>                           <span class="nx">bands</span><span class="o">:</span> <span class="nx">convertGremlinTable</span><span class="p">(</span><span class="nx">bands</span><span class="p">)</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="s1">&#39;&lt;h3&gt;{{artist}} Performs these Roles&lt;/h3&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;ul&gt;{{#roles}}&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;{{.}}&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{/roles}}&lt;/ul&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h3&gt;Play in Bands&lt;/h3&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;ul&gt;{{#bands}}&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;&lt;a href=&quot;/band?name={{name}}&quot;&gt;{{name}}&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{#from}} from {{from}}{{/from}}&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{#to}} to {{to}}{{/to}}&lt;/a&gt;&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/a&gt;&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{/bands}}&lt;/ul&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">writeTemplate</span><span class="p">(</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">values</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * A band name search. Used for autocompletion.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;^/search$&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">redisClient</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="s2">&quot;band-name:&quot;</span><span class="o">+</span><span class="nx">query</span><span class="o">+</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">keys</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">bands</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="nx">keys</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">bands</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;band-name:&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">bands</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// catch all unknown routes with a 404</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;.+&quot;</span><span class="p">,</span> <span class="nx">appServer</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">fourohfour</span><span class="p">);</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;.+&quot;</span><span class="p">,</span> <span class="nx">appServer</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">loghandler</span><span class="p">,</span> <span class="p">{</span> <span class="nx">section</span><span class="o">:</span> <span class="s2">&quot;final&quot;</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// start up the server</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Starting Server on port &quot;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">createServer</span><span class="p">().</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Add Music Samples</h3>

<p>The book (in beta 5.0) suggested to use Riak&#8217;s Luwak, but this
component has recently been removed, and there seems to be no
replacement at this time. So I went with MongoDB&#8217;s
<a href="http://www.mongodb.org/display/DOCS/GridFS">GridFS</a> instead. This is
a little more complex than a simple replacement of the client
libraries: MongoDB does not have an HTTP ReST API for GridFS, so I
need to stream the content of the file through the server.</p>

<h4>Overview</h4>

<p>To keep things simple, I load only on sample per band; the file name
must be the same as the CouchDB key, followed by &#8216;.mp3&#8217;.</p>

<p>To access MongoDB from Node.js, I use
<a href="http://github.com/christkv/node-mongodb-native">node-mongodb-native</a>,
which can be installed with <code>npm</code>. It has all the expected features of
a client, including GridFS support (with one caveat, see below).</p>

<p>To stream the file from the server, I use a dedicated port, for no
better reason than because
<a href="http://bricksjs.com/index.html">Brick.js</a>, that the authors used to
build the service, was giving me trouble, while the standard <code>http</code>
module did not.</p>

<p>When displaying the band information, I check whether a file exists
with the same name as the band&#8217;s key: if it does, I add a link to the
dedicated streaming port, passing the key as parameter:</p>

<figure class='code'><figcaption><span>Adding Sample Link  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">mongoClient</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">mongodb</span><span class="p">.</span><span class="nx">GridStore</span><span class="p">.</span><span class="nx">exist</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">bandKey</span> <span class="o">+</span> <span class="s1">&#39;.mp3&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">exist</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">exist</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;a href=&quot;http://&#39;</span><span class="o">+</span><span class="nx">host</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nx">streamPort</span><span class="o">+</span><span class="s1">&#39;?band=&quot;&gt;Sample&lt;/a&gt;&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, I create a new <code>http</code> server to send the music:</p>

<figure class='code'><figcaption><span>Streaming Files from GridFS  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">band</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">query</span><span class="p">.</span><span class="nx">band</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">mongoClient</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">gs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">GridStore</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">band</span><span class="o">+</span><span class="s1">&#39;.mp3&#39;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">gs</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;streaming...&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">response</span><span class="p">.</span><span class="nx">writeHeader</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>                <span class="s1">&#39;Content-type&#39;</span><span class="o">:</span> <span class="s1">&#39;audio/mpeg, audio/x-mpeg, audio/x-mpeg-3, audio/mpeg3&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="c1">// magic headers to stream mp3...</span>
</span><span class='line'>                <span class="s1">&#39;X-Pad&#39;</span><span class="o">:</span> <span class="s1">&#39;avoid browser bug&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;Cache-Control&#39;</span><span class="o">:</span> <span class="s1">&#39;no-cache&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;Content-Length&#39;</span><span class="o">:</span> <span class="nx">gs</span><span class="p">.</span><span class="nx">length</span><span class="p">});</span>
</span><span class='line'><span class="c1">// cannot use gridstore streams; somehow file always</span>
</span><span class='line'><span class="c1">// truncated - load in memory instead</span>
</span><span class='line'><span class="c1">//            gs.stream(true).pipe(response);</span>
</span><span class='line'>            <span class="nx">gs</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">gs</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'>                <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">streamPort</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The only problem I had (but it took me a while to figure it out) was
that the stream support in the MongoDB client for GridFS content is
(as far as I can tell) defective: it will close the stream after just
one or two chunks&#8217; worth of data
(<a href="https://github.com/christkv/node-mongodb-native/issues/540">Issue in Github</a>).</p>

<p>So instead I have to load the whole file in memory then write it in
the response&#8230; Clearly not the best approach, but hey, it works!</p>

<h4>Full Code</h4>

<figure class='code'><figcaption><span> (bands.js)</span> <a href='/downloads/code/7d7w/redis/day3/mp3/bands.js'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/***</span>
</span><span class='line'><span class="cm"> * Excerpted from &quot;Seven Databases in Seven Weeks&quot;,</span>
</span><span class='line'><span class="cm"> * published by The Pragmatic Bookshelf.</span>
</span><span class='line'><span class="cm"> * Copyrights apply to this code. It may not be used to create training material, </span>
</span><span class='line'><span class="cm"> * courses, books, articles, and the like. Contact us if you are in doubt.</span>
</span><span class='line'><span class="cm"> * We make no guarantees that this code is fit for any purpose. </span>
</span><span class='line'><span class="cm"> * Visit http://www.pragmaticprogrammer.com/titles/rwdata for more book information.</span>
</span><span class='line'><span class="cm">***/</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span>
</span><span class='line'>  <span class="nx">port</span> <span class="o">=</span> <span class="mi">8080</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">streamPort</span> <span class="o">=</span> <span class="mi">8089</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">host</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">jsonHeader</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="s1">&#39;application/json&#39;</span><span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// standard libraries</span>
</span><span class='line'>  <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">bricks</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bricks&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">mustache</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mustache&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// mongodb</span>
</span><span class='line'>  <span class="nx">mongodb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// custom libraries</span>
</span><span class='line'>  <span class="nx">couchUtil</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./populate_couch.js&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">neo4j</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./neo4j_caching_client.js&#39;</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// database clients</span>
</span><span class='line'>  <span class="nx">couchClient</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="mi">5984</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">neo4jClient</span> <span class="o">=</span> <span class="nx">neo4j</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(),</span>
</span><span class='line'>  <span class="nx">redisClient</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="mi">6379</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">mongoClient</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">new</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">Db</span><span class="p">(</span><span class="s1">&#39;music&#39;</span><span class="p">,</span>
</span><span class='line'>                   <span class="k">new</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span><span class='line'>                                      <span class="nx">mongodb</span><span class="p">.</span><span class="nx">Connection</span><span class="p">.</span><span class="nx">DEFAULT_PORT</span><span class="p">,</span> <span class="p">{}),</span>
</span><span class='line'>                   <span class="p">{</span><span class="nx">native_parser</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span>
</span><span class='line'>  <span class="nx">gremlin</span> <span class="o">=</span> <span class="nx">neo4jClient</span><span class="p">.</span><span class="nx">runGremlin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * A convenience function for wrapping the</span>
</span><span class='line'><span class="cm"> * reading of JSON reponse data chunks.</span>
</span><span class='line'><span class="cm"> * @param response A Node HTTP response object.</span>
</span><span class='line'><span class="cm"> * @param callback the function to populate and call on completion.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">processBuffer</span><span class="p">(</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">buffer</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">buffer</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">callback</span><span class="p">(</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Post one or more documents into CouchDB.</span>
</span><span class='line'><span class="cm"> * @param url is where we POST to.</span>
</span><span class='line'><span class="cm"> * @param docString a stringified JSON document.</span>
</span><span class='line'><span class="cm"> * @param count the number of documents being inserted.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">getCouchDoc</span><span class="p">(</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">httpResponse</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">couchClient</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">jsonHeader</span> <span class="p">);</span>
</span><span class='line'>  <span class="nx">request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">request</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!=</span> <span class="mi">200</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">writeTemplate</span><span class="p">(</span> <span class="nx">httpResponse</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Value not found&quot;</span> <span class="p">}</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">processBuffer</span><span class="p">(</span> <span class="nx">response</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">couchObj</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">callback</span><span class="p">(</span> <span class="nx">couchObj</span> <span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}).</span>
</span><span class='line'>  <span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;postDoc Got error: &#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Wraps a block of HTML with a standard template. HTML lives in template.html.</span>
</span><span class='line'><span class="cm"> * @innerHtml populates the body of the template</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">htmlTemplate</span><span class="p">(</span> <span class="nx">innerHtml</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">file_data</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span> <span class="s1">&#39;template.html&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span> <span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">file_data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;[[YIELD]]&quot;</span><span class="p">,</span> <span class="nx">innerHtml</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">writeTemplate</span><span class="p">(</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">innerHtml</span><span class="p">,</span> <span class="nx">values</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span> <span class="nx">mustache</span><span class="p">.</span><span class="nx">to_html</span><span class="p">(</span> <span class="nx">htmlTemplate</span><span class="p">(</span> <span class="nx">innerHtml</span> <span class="p">),</span> <span class="nx">values</span> <span class="p">));</span>
</span><span class='line'>  <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">convertGremlinTable</span><span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">fromTableToObject</span><span class="p">(</span><span class="nx">table</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">columns</span><span class="p">,</span> <span class="nx">table</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">fromTableToObject</span><span class="p">(</span><span class="nx">columns</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">columns</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="nx">obj</span><span class="p">[</span><span class="nx">columns</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// A Nodejs web app utility setup</span>
</span><span class='line'><span class="nx">appServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bricks</span><span class="p">.</span><span class="nx">appserver</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// attach request plugin to easily extract params</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;^/&quot;</span><span class="p">,</span> <span class="nx">appServer</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">request</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Just display a blank form if no band is given.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;^/$&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">writeTemplate</span><span class="p">(</span> <span class="nx">res</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Find a band&quot;</span> <span class="p">}</span> <span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Accepts a band name and displays all artists in the band.</span>
</span><span class='line'><span class="cm"> * Also displays a list of suggested bands where at least</span>
</span><span class='line'><span class="cm"> * one artist has played at one time.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Gremlin: aliases introduced for the same node and/or</span>
</span><span class='line'><span class="cm"> * relationship appear to be used in reverse order in</span>
</span><span class='line'><span class="cm"> * Tables.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;^/band$&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">bandName</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
</span><span class='line'>      <span class="nx">bandKey</span> <span class="o">=</span> <span class="nx">couchUtil</span><span class="p">.</span><span class="nx">couchKeyify</span><span class="p">(</span> <span class="nx">bandName</span> <span class="p">),</span>
</span><span class='line'>      <span class="nx">bandNodePath</span> <span class="o">=</span> <span class="s1">&#39;/bands/&#39;</span> <span class="o">+</span> <span class="nx">bandKey</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">queryPrefix</span> <span class="o">=</span> <span class="s1">&#39;g.idx(&quot;bands&quot;)[[&quot;name&quot;:&quot;&#39;</span><span class="o">+</span><span class="nx">bandName</span><span class="o">+</span><span class="s1">&#39;&quot;]]&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">otherBandsQuery</span> <span class="o">=</span> <span class="nx">queryPrefix</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.out(&quot;member&quot;).in(&quot;member&quot;).dedup.name&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">currentMembersQuery</span> <span class="o">=</span> <span class="nx">queryPrefix</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.outE(&quot;member&quot;).as(&quot;from&quot;)&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.filter{it.to == null}.inV.as(&quot;name&quot;)&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.table(new Table()){it.from}{it.name}.cap()&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">otherMembersQuery</span> <span class="o">=</span> <span class="nx">queryPrefix</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.outE(&quot;member&quot;).as(&quot;from&quot;).as(&quot;to&quot;)&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.filter{it.to != null}.inV.as(&quot;name&quot;)&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.table(new Table())&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;{it.to}{it.from}{it.name}.cap()&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">gremlin</span><span class="p">(</span><span class="nx">otherBandsQuery</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">graphData</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">gremlin</span><span class="p">(</span><span class="nx">currentMembersQuery</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">currentMembers</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">gremlin</span><span class="p">(</span><span class="nx">otherMembersQuery</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">otherMembers</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">{</span><span class="nx">band</span><span class="o">:</span> <span class="nx">bandName</span><span class="p">,</span> <span class="nx">bands</span><span class="o">:</span> <span class="nx">graphData</span><span class="p">,</span>
</span><span class='line'>                             <span class="nx">currents</span><span class="o">:</span> <span class="nx">convertGremlinTable</span><span class="p">(</span><span class="nx">currentMembers</span><span class="p">),</span>
</span><span class='line'>                             <span class="nx">others</span><span class="o">:</span> <span class="nx">convertGremlinTable</span><span class="p">(</span><span class="nx">otherMembers</span><span class="p">),</span>
</span><span class='line'>                             <span class="nx">bandK</span><span class="o">:</span> <span class="nx">bandKey</span><span class="p">};</span>
</span><span class='line'>                <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="s1">&#39;&lt;h2&gt;Current {{band}} Band Members&lt;/h2&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">currentMembers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;ul&gt;{{#currents}}&#39;</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;&lt;a href=&quot;/artist?name={{name}}&quot;&gt;{{name}}&#39;</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{#from}} from {{from}}{{/from}}&lt;/a&gt;&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{/currents}}&#39;</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">body</span> <span class="o">+=</span> <span class="s2">&quot;&lt;p&gt;No current member (dead band?)&lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="nx">mongoClient</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">mongodb</span><span class="p">.</span><span class="nx">GridStore</span><span class="p">.</span><span class="nx">exist</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">bandKey</span> <span class="o">+</span> <span class="s1">&#39;.mp3&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">exist</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="nx">exist</span><span class="p">)</span>
</span><span class='line'>                            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;a href=&quot;http://&#39;</span><span class="o">+</span><span class="nx">host</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nx">streamPort</span><span class="o">+</span><span class="s1">&#39;?band={{bandK}}&quot;&gt;Sample&lt;/a&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="nx">otherMembers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h3&gt;Other members&lt;/h3&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;ul&gt;{{#others}}&#39;</span><span class="p">;</span>
</span><span class='line'>                            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;&lt;a href=&quot;/artist?name={{name}}&quot;&gt;{{name}}&#39;</span><span class="p">;</span>
</span><span class='line'>                            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{#from}} from {{from}}{{/from}}&#39;</span><span class="p">;</span>
</span><span class='line'>                            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{#to}} to {{to}}{{/to}}&lt;/a&gt;&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{/others}}&lt;/ul&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                        <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h3&gt;You may also like&lt;/h3&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                        <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;ul&gt;{{#bands}}&#39;</span><span class="p">;</span>
</span><span class='line'>                        <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;&lt;a href=&quot;/band?name={{.}}&quot;&gt;{{.}}&lt;/a&gt;&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>                        <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{/bands}}&lt;/ul&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                        <span class="nx">writeTemplate</span><span class="p">(</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">values</span> <span class="p">);</span>
</span><span class='line'>                        <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</span><span class='line'>                    <span class="p">});</span>
</span><span class='line'>                <span class="p">});</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Accepts an artist name and displays band and role information</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;^/artist$&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">artistName</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">queryPrefix</span> <span class="o">=</span> <span class="s1">&#39;g.idx(&quot;artists&quot;)[[&quot;name&quot;:&quot;&#39;</span><span class="o">+</span><span class="nx">artistName</span><span class="o">+</span><span class="s1">&#39;&quot;]]&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">rolesQuery</span> <span class="o">=</span> <span class="nx">queryPrefix</span> <span class="o">+</span><span class="s1">&#39;.out(&quot;plays&quot;).role.dedup&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">bandsQuery</span> <span class="o">=</span> <span class="s1">&#39;g.idx(&quot;artists&quot;)[[&quot;name&quot;:&quot;&#39;</span><span class="o">+</span><span class="nx">artistName</span><span class="o">+</span><span class="s1">&#39;&quot;]]&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.inE(&quot;member&quot;).as(&quot;to&quot;).as(&quot;from&quot;).outV.as(&quot;name&quot;)&#39;</span>
</span><span class='line'>            <span class="o">+</span> <span class="s1">&#39;.table(new Table()){it.from}{it.to}{it.name}.cap()&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">gremlin</span><span class="p">(</span> <span class="nx">rolesQuery</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">roles</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">gremlin</span><span class="p">(</span> <span class="nx">bandsQuery</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bands</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">artist</span><span class="o">:</span> <span class="nx">artistName</span><span class="p">,</span> <span class="nx">roles</span><span class="o">:</span> <span class="nx">roles</span><span class="p">,</span>
</span><span class='line'>                           <span class="nx">bands</span><span class="o">:</span> <span class="nx">convertGremlinTable</span><span class="p">(</span><span class="nx">bands</span><span class="p">)</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="s1">&#39;&lt;h3&gt;{{artist}} Performs these Roles&lt;/h3&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;ul&gt;{{#roles}}&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;{{.}}&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{/roles}}&lt;/ul&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h3&gt;Play in Bands&lt;/h3&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;ul&gt;{{#bands}}&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;&lt;a href=&quot;/band?name={{name}}&quot;&gt;{{name}}&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{#from}} from {{from}}{{/from}}&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{#to}} to {{to}}{{/to}}&lt;/a&gt;&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/a&gt;&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">body</span> <span class="o">+=</span> <span class="s1">&#39;{{/bands}}&lt;/ul&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">writeTemplate</span><span class="p">(</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">values</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * A band name search. Used for autocompletion.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;^/search$&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">redisClient</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="s2">&quot;band-name:&quot;</span><span class="o">+</span><span class="nx">query</span><span class="o">+</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">keys</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">bands</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="nx">keys</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">bands</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;band-name:&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">bands</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// cannot seem to get bricks to stream data back</span>
</span><span class='line'><span class="c1">// use simple default http server</span>
</span><span class='line'><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">band</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">query</span><span class="p">.</span><span class="nx">band</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">mongoClient</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">gs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongodb</span><span class="p">.</span><span class="nx">GridStore</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">band</span><span class="o">+</span><span class="s1">&#39;.mp3&#39;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">gs</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;streaming...&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">response</span><span class="p">.</span><span class="nx">writeHeader</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>                <span class="s1">&#39;Content-type&#39;</span><span class="o">:</span> <span class="s1">&#39;audio/mpeg, audio/x-mpeg, audio/x-mpeg-3, audio/mpeg3&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="c1">// magic headers to stream mp3...</span>
</span><span class='line'>                <span class="s1">&#39;X-Pad&#39;</span><span class="o">:</span> <span class="s1">&#39;avoid browser bug&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;Cache-Control&#39;</span><span class="o">:</span> <span class="s1">&#39;no-cache&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;Content-Length&#39;</span><span class="o">:</span> <span class="nx">gs</span><span class="p">.</span><span class="nx">length</span><span class="p">});</span>
</span><span class='line'><span class="c1">// cannot use gridstore streams; somehow file always</span>
</span><span class='line'><span class="c1">// truncated - load in memory instead</span>
</span><span class='line'><span class="c1">//            gs.stream(true).pipe(response);</span>
</span><span class='line'>            <span class="nx">gs</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">gs</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'>                <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">streamPort</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// catch all unknown routes with a 404</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;.+&quot;</span><span class="p">,</span> <span class="nx">appServer</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">fourohfour</span><span class="p">);</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">addRoute</span><span class="p">(</span><span class="s2">&quot;.+&quot;</span><span class="p">,</span> <span class="nx">appServer</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">loghandler</span><span class="p">,</span> <span class="p">{</span> <span class="nx">section</span><span class="o">:</span> <span class="s2">&quot;final&quot;</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// start up the server</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Starting Server on port &quot;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
</span><span class='line'><span class="nx">appServer</span><span class="p">.</span><span class="nx">createServer</span><span class="p">().</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Wrapping Up</h2>

<p>Well, that was a long day. I should have enjoyed it, but the lack of
maturity in some of the tools (Neo4j&#8217;s always evolving query language
and the GridFS streaming bug) caused hours of frustration. The main
cause, however, was missing knowledge: faced with an unexpected
behaviour, I had no idea whether it was a bug (find a workaround) or
an incorrect invocation (rework the query to correct it).</p>

<p>The exposition of polyglot persistence through the music information
service were pretty good, given the space constraint. Of course it
skipped the really ugly and tedious parts (how to incrementally keep
the databases in sync when the main records are updated, not merely
created); given the variation in data models, data manipulation (or
lack thereof) and query between the different databases, this can
easily become a nightmare (especially if incremental updates are not
part of the initial design).</p>

<p>Another upcoming book, <a href="http://www.manning.com/marz/">Big Data</a>, takes
a very different approach (no updates, only appends). I look forward
to reading it.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Frédéric Dumont</span></span>

      








  


<time datetime="2012-03-14T15:48:00+09:00" pubdate data-updated="true">Mar 14<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/books/'>Books</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.wakatta.jp/blog/2012/03/14/seven-databases-in-seven-weeks-redis-day-3/" data-via="" data-counturl="http://blog.wakatta.jp/blog/2012/03/14/seven-databases-in-seven-weeks-redis-day-3/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/03/10/concrete-mathematics-chapter-2-basics/" title="Previous Post: Concrete Mathematics Chapter 2 Basics">&laquo; Concrete Mathematics Chapter 2 Basics</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/03/15/seven-databases-in-seven-weeks-wrapping-up/" title="next Post: Seven Databases in Seven Weeks Wrapping Up">Seven Databases in Seven Weeks Wrapping Up &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Wakatta!</h1>
  <p>
		<a href="/about">more...</a>
	</p>
</section>

<section>
	<h1>Seven Databases in Seven Weeks Series</h1>
	
		<ul>
		
			<li class="post"><a href="/blog/2011/12/03/new-book-seven-databases-in-seven-weeks/">Intro</a></li>
		
			<li class="post"><a href="/blog/2011/12/03/seven-databases-in-seven-weeks-postgresql-day-1/">PostgreSQL Day 1</a></li>
		
			<li class="post"><a href="/blog/2011/12/03/seven-databases-in-seven-weeks-postgresql-day-2/">PostgreSQL Day 2</a></li>
		
			<li class="post"><a href="/blog/2011/12/04/seven-databases-in-seven-weeks-postgresql-day-3/">PostgreSQL Day 3</a></li>
		
			<li class="post"><a href="/blog/2011/12/08/seven-databases-in-seven-weeks-riak-day-1/">Riak Day 1</a></li>
		
			<li class="post"><a href="/blog/2011/12/08/seven-databases-in-seven-weeks-riak-day-2/">Riak Day 2</a></li>
		
			<li class="post"><a href="/blog/2011/12/09/seven-databases-in-seven-weeks-riak-day-3/">Riak Day 3</a></li>
		
			<li class="post"><a href="/blog/2011/12/11/seven-databases-in-seven-weeks-hbase-day-1/">HBase Day 1</a></li>
		
			<li class="post"><a href="/blog/2011/12/12/seven-databases-in-seven-weeks-hbase-day-2/">HBase Day 2</a></li>
		
			<li class="post"><a href="/blog/2011/12/15/seven-databases-in-seven-weeks-hbase-day-3/">HBase Day 3</a></li>
		
			<li class="post"><a href="/blog/2011/12/17/seven-databases-in-seven-weeks-riak-on-ec2/">Riak on EC2</a></li>
		
			<li class="post"><a href="/blog/2011/12/23/seven-databases-in-seven-weeks-mongodb-day-1/">MongoDB Day 1</a></li>
		
			<li class="post"><a href="/blog/2011/12/24/seven-databases-in-seven-weeks-mongodb-day-2/">MongoDB Day 2</a></li>
		
			<li class="post"><a href="/blog/2011/12/25/seven-databases-in-seven-weeks-mongodb-day-3/">MongoDB Day 3</a></li>
		
			<li class="post"><a href="/blog/2011/12/28/seven-databases-in-seven-weeks-neo4j-day-1/">Neo4j Day 1</a></li>
		
			<li class="post"><a href="/blog/2011/12/29/seven-databases-in-seven-weeks-neo4j-day-2/">Neo4j Day 2</a></li>
		
			<li class="post"><a href="/blog/2011/12/30/seven-databases-in-seven-weeks-neo4j-day-3/">Neo4j Day 3</a></li>
		
			<li class="post"><a href="/blog/2012/01/20/seven-databases-in-seven-weeks-redis-day-1/">Redis Day 1</a></li>
		
			<li class="post"><a href="/blog/2012/01/21/seven-databases-in-seven-weeks-redis-day-2/">Redis Day 2</a></li>
		
			<li class="post"><a href="/blog/2012/01/30/seven-databases-in-seven-weeks-couchdb-day-1/">CouchDB Day 1</a></li>
		
			<li class="post"><a href="/blog/2012/01/30/seven-databases-in-seven-weeks-couchdb-day-2/">CouchDB Day 2</a></li>
		
			<li class="post"><a href="/blog/2012/02/01/seven-databases-in-seven-weeks-couchdb-day-3/">CouchDB Day 3</a></li>
		
			<li class="post"><a href="/blog/2012/03/14/seven-databases-in-seven-weeks-redis-day-3/">Redis Day 3</a></li>
		
			<li class="post"><a href="/blog/2012/03/15/seven-databases-in-seven-weeks-wrapping-up/">Wrapping Up</a></li>
		
		</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/03/15/seven-databases-in-seven-weeks-wrapping-up/">Seven Databases in Seven Weeks Wrapping Up</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/14/seven-databases-in-seven-weeks-redis-day-3/">Seven Databases in Seven Weeks Redis Day 3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/10/concrete-mathematics-chapter-2-basics/">Concrete Mathematics Chapter 2 Basics</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/28/concrete-mathematics-chapter-2-warmups/">Concrete Mathematics Chapter 2 Warmups</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/27/concrete-mathematics-chapter-2-notes/">Concrete Mathematics Chapter 2 Notes</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/fdumontmd">@fdumontmd</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'fdumontmd',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Frédéric Dumont -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>
  
  </span>
</p>

</footer>
  

<div class="tex2jax_ignore">
<script type="text/javascript">
      var disqus_shortname = 'wakatta-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.wakatta.jp/blog/2012/03/14/seven-databases-in-seven-weeks-redis-day-3/';
        var disqus_url = 'http://blog.wakatta.jp/blog/2012/03/14/seven-databases-in-seven-weeks-redis-day-3/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>
</div>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
